// module/movement/temporary-speed.js
// ------------------------------------------------------------
// Car Wars Deluxe — Temporary Speed Table (TST) (Phase 2)
// Pure logic only. No actor updates, no chat, no UI.
// ------------------------------------------------------------

const FRACTIONS = {
  "1": 1,
  "¾": 0.75,
  "½": 0.5,
  "¼": 0.25,
  "0": 0
};

// RAW TST table
export const TST = [
  ["½","¾","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","1","¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","1","1","¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","1","1","1","¾","¾","½","½","¼","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","1","1","1","1","¾","¾","¾","½","½","¼","¼","0","0","0","0","0","0","0","0","0"],
  ["1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0","0","0","0","0","0","0"],
  ["1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0","0","0","0","0","0"],
  ["1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0","0","0","0","0"],
  ["1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0","0","0","0"],
  ["1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0","0","0"],
  ["1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0","0"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼","0"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼","¼"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½","¼"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½","½"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½","½"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾","½"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾","¾"],
  ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","¾","¾"]
];

function parseFraction(str) {
  return FRACTIONS[str] ?? 1;
}

function roundUpTo5(x) {
  return Math.ceil(x / 5) * 5;
}

/**
 * Pure logic: compute temporary speed after collision.
 */
export function getTemporarySpeed(myDM, theirDM, originalSpeed) {
  const myIndex = Math.max(0, Math.min(20, Math.floor(myDM)));
  const theirIndex = Math.max(0, Math.min(20, Math.floor(theirDM)));

  const fractionStr = TST[myIndex][theirIndex];
  const multiplier = parseFraction(fractionStr);

  return roundUpTo5(originalSpeed * multiplier);
}
