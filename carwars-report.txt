============================================================
FOLDER TREE
============================================================
- \assets
- \data
- \module
- \packs
- \styles
- \templates
 - \assets\icons
 - \assets\templates
 - \assets\ui
 - \module\actor
 - \module\construction
 - \module\helpers
 - \module\item
 - \module\movement
 - \module\rolls
 - \module\rules
 - \module\ui
  - \module\actor\templates
  - \module\construction\validation
  - \module\movement\orchestrator
  - \module\rules\apply
  - \module\rules\loaders
  - \module\ui\chat
  - \module\ui\combat
  - \module\ui\movement
  - \module\ui\pedestrian
  - \module\ui\utils
 - \templates\actor
 - \templates\chat
 - \templates\item
  - \templates\actor\partials

============================================================
FILE LIST (name, type, size)
============================================================
\.gitattributes  [.gitattributes]  66 bytes
\apibuild  []  2,379 bytes
\apibuild.ps1  [.ps1]  4,322 bytes
\carwars-report.txt  [.txt]  0 bytes
\carwars-system.code-workspace  [.code-workspace]  246 bytes
\comparefiles.ps1  [.ps1]  3,950 bytes
\console-export-2026-1-3_10-14-10.log  [.log]  14,917 bytes
\createfilestructure  []  1,417 bytes
\createfilestructure.ps1  [.ps1]  1,417 bytes
\fixranges.ps1  [.ps1]  1,721 bytes
\getcarwarsinfo  []  141 bytes
\getcarwarsinfo.ps1  [.ps1]  2,363 bytes
\importexportmap.ps1  [.ps1]  2,668 bytes
\movepartials.ps1  [.ps1]  2,319 bytes
\outputfilestructure.ps1  [.ps1]  197 bytes
\phase1check  []  1,520 bytes
\phase1check.ps1  [.ps1]  3,815 bytes
\phase5check  []  1,723 bytes
\phase5check.ps1  [.ps1]  1,723 bytes
\read.md  [.md]  3,716 bytes
\rewriteorchestrator  []  1,478 bytes
\rewriteorchestrator.ps1  [.ps1]  1,478 bytes
\synctofoundry.ps1  [.ps1]  3,738 bytes
\system.json  [.json]  657 bytes
\systemanalysis.ps1  [.ps1]  1,030 bytes
\template.json  [.json]  255 bytes
\test-carwarssystem.ps1  [.ps1]  5,990 bytes
\validationbuilder.ps1  [.ps1]  6,462 bytes
\assets\CW-Turning-Key.webp  [.webp]  158,020 bytes
\assets\turning-key,svg.xml  [.xml]  2,116 bytes
\data\accessories.json  [.json]  6,941 bytes
\data\armor.json  [.json]  1,746 bytes
\data\bodies.json  [.json]  12,594 bytes
\data\chassis.json  [.json]  2,272 bytes
\data\engine-mods.json  [.json]  7,350 bytes
\data\gas-tanks.json  [.json]  709 bytes
\data\powerplants.json  [.json]  6,666 bytes
\data\suspension.json  [.json]  2,505 bytes
\data\tire-options.json  [.json]  3,598 bytes
\data\tires.json  [.json]  1,227 bytes
\data\weapons.json  [.json]  83,570 bytes
\module\carwars.js  [.js]  14,041 bytes
\module\config.js  [.js]  9 bytes
\module\actor\actor-sheet.js  [.js]  15,030 bytes
\module\actor\armor-init.js  [.js]  5,321 bytes
\module\actor\base-actor.js  [.js]  170 bytes
\module\actor\driver-data.js  [.js]  403 bytes
\module\actor\register-sheets.js  [.js]  900 bytes
\module\actor\vehicle-data.js  [.js]  11,202 bytes
\module\actor\templates\driver-sheet.hbs  [.hbs]  3,941 bytes
\module\actor\templates\vehicle-sheet.hbs  [.hbs]  6,010 bytes
\module\construction\armor-calculator.js  [.js]  0 bytes
\module\construction\catalog-loader.js  [.js]  2,730 bytes
\module\construction\chassis.js  [.js]  0 bytes
\module\construction\derived-stats.js  [.js]  0 bytes
\module\construction\load-calculator.js  [.js]  0 bytes
\module\construction\validation.js  [.js]  5,093 bytes
\module\construction\validation\index.js  [.js]  2,222 bytes
\module\construction\validation\validate-accessories.js  [.js]  8,622 bytes
\module\construction\validation\validate-armor.js  [.js]  7,233 bytes
\module\construction\validation\validate-body.js  [.js]  6,662 bytes
\module\construction\validation\validate-chassis.js  [.js]  6,011 bytes
\module\construction\validation\validate-crew.js  [.js]  5,740 bytes
\module\construction\validation\validate-gas-tank.js  [.js]  6,232 bytes
\module\construction\validation\validate-internal.js  [.js]  6,447 bytes
\module\construction\validation\validate-performance.js  [.js]  6,213 bytes
\module\construction\validation\validate-powerplant.js  [.js]  6,819 bytes
\module\construction\validation\validate-spaces.js  [.js]  5,564 bytes
\module\construction\validation\validate-suspension.js  [.js]  4,964 bytes
\module\construction\validation\validate-tires.js  [.js]  6,353 bytes
\module\construction\validation\validate-vehicle.js  [.js]  3,474 bytes
\module\construction\validation\validate-weapons.js  [.js]  8,295 bytes
\module\construction\validation\validate-weight.js  [.js]  6,614 bytes
\module\helpers\template-loader.js  [.js]  255 bytes
\module\movement\armor-damage-router.js  [.js]  4,109 bytes
\module\movement\bootlegger-template.js  [.js]  2,611 bytes
\module\movement\collision-detection.js  [.js]  3,399 bytes
\module\movement\collision-engine.js  [.js]  5,352 bytes
\module\movement\collision-physics.js  [.js]  4,527 bytes
\module\movement\collision-router.js  [.js]  2,711 bytes
\module\movement\collision-type.js  [.js]  3,800 bytes
\module\movement\conforming.js  [.js]  3,694 bytes
\module\movement\control-table.js  [.js]  3,625 bytes
\module\movement\crash-router.js  [.js]  1,794 bytes
\module\movement\crash-table-1.js  [.js]  2,855 bytes
\module\movement\crash-table-2.js  [.js]  3,170 bytes
\module\movement\damage-modifier.js  [.js]  5,680 bytes
\module\movement\fishtail-physics.js  [.js]  4,791 bytes
\module\movement\hazard-engine.js  [.js]  2,147 bytes
\module\movement\index.js  [.js]  816 bytes
\module\movement\lane-change-template.js  [.js]  2,739 bytes
\module\movement\maneuver-registry.js  [.js]  2,317 bytes
\module\movement\movement-api.js  [.js]  1,324 bytes
\module\movement\movement-engine.js  [.js]  4,002 bytes
\module\movement\movement-phase-ui-adapter.js  [.js]  1,229 bytes
\module\movement\movement-state.js  [.js]  4,090 bytes
\module\movement\movement-template.js  [.js]  2,794 bytes
\module\movement\perform-maneuver.js  [.js]  4,824 bytes
\module\movement\phase-tracker.js  [.js]  2,087 bytes
\module\movement\roll-physics.js  [.js]  3,188 bytes
\module\movement\skid-physics.js  [.js]  2,811 bytes
\module\movement\skid-template.js  [.js]  1,835 bytes
\module\movement\spinout-template.js  [.js]  1,196 bytes
\module\movement\spinout.js  [.js]  1,448 bytes
\module\movement\templates.js  [.js]  3,934 bytes
\module\movement\temporary-speed.js  [.js]  2,991 bytes
\module\movement\turn-arc-template.js  [.js]  2,945 bytes
\module\movement\turningkey-measuredtemplate.js  [.js]  2,762 bytes
\module\movement\turningkey-template.js  [.js]  2,972 bytes
\module\movement\vault-physics.js  [.js]  4,000 bytes
\module\movement\orchestrator\collision-flow.js  [.js]  661 bytes
\module\movement\orchestrator\collision-flow.js.bak  [.bak]  696 bytes
\module\movement\orchestrator\control-flow.js  [.js]  530 bytes
\module\movement\orchestrator\control-flow.js.bak  [.bak]  543 bytes
\module\movement\orchestrator\crash-flow.js  [.js]  593 bytes
\module\movement\orchestrator\crash-flow.js.bak  [.bak]  605 bytes
\module\movement\orchestrator\hazard-flow.js  [.js]  519 bytes
\module\movement\orchestrator\hazard-flow.js.bak  [.bak]  532 bytes
\module\movement\orchestrator\index.js  [.js]  816 bytes
\module\movement\orchestrator\maneuver-flow.js  [.js]  761 bytes
\module\movement\orchestrator\maneuver-flow.js.bak  [.bak]  792 bytes
\module\movement\orchestrator\movement-flow.js  [.js]  1,018 bytes
\module\movement\orchestrator\movement-flow.js.bak  [.bak]  1,033 bytes
\module\movement\orchestrator\movement-orchestrator.js  [.js]  1,762 bytes
\module\movement\orchestrator\movement-orchestrator.js.bak  [.bak]  1,757 bytes
\module\movement\orchestrator\movement-phase-orchestrator.js  [.js]  1,741 bytes
\module\movement\orchestrator\movement-phase-orchestrator.js.bak  [.bak]  1,724 bytes
\module\movement\orchestrator\movement-phase-result.js  [.js]  437 bytes
\module\movement\orchestrator\movement-phase-schema.js  [.js]  979 bytes
\module\movement\orchestrator\movement-phase-ui-adapter.js  [.js]  559 bytes
\module\movement\orchestrator\movement-phase-ui-adapter.js.bak  [.bak]  573 bytes
\module\movement\orchestrator\movement-phase-validator.js  [.js]  1,721 bytes
\module\movement\orchestrator\movement-phase-validator.js.bak  [.bak]  1,729 bytes
\module\rolls\control-rolls.js  [.js]  3,108 bytes
\module\rolls\hazard.js  [.js]  0 bytes
\module\rules\rule-engine.js  [.js]  2,514 bytes
\module\rules\apply\apply-accessories.js  [.js]  1,152 bytes
\module\rules\apply\apply-armor.js  [.js]  469 bytes
\module\rules\apply\apply-body.js  [.js]  846 bytes
\module\rules\apply\apply-chassis.js  [.js]  411 bytes
\module\rules\apply\apply-engine.js  [.js]  539 bytes
\module\rules\apply\apply-gas-tank.js  [.js]  439 bytes
\module\rules\apply\apply-suspension.js  [.js]  594 bytes
\module\rules\apply\apply-tires.js  [.js]  411 bytes
\module\rules\apply\apply-weapons.js  [.js]  534 bytes
\module\rules\loaders\accessories-loader.js  [.js]  60 bytes
\module\rules\loaders\armor-loader.js  [.js]  54 bytes
\module\rules\loaders\body-loader.js  [.js]  53 bytes
\module\rules\loaders\chassis-loader.js  [.js]  56 bytes
\module\rules\loaders\engine-loader.js  [.js]  55 bytes
\module\rules\loaders\gas-tank-loader.js  [.js]  57 bytes
\module\rules\loaders\suspension-loader.js  [.js]  59 bytes
\module\rules\loaders\tires-loader.js  [.js]  54 bytes
\module\rules\loaders\weapons-loader.js  [.js]  56 bytes
\module\ui\helpers.js  [.js]  0 bytes
\module\ui\hud.js  [.js]  0 bytes
\module\ui\chat\control-roll-card.js  [.js]  641 bytes
\module\ui\chat\crash-card.js  [.js]  518 bytes
\module\ui\chat\hazard-card.js  [.js]  547 bytes
\module\ui\movement\control-roll-result-handler.js  [.js]  1,027 bytes
\module\ui\movement\maneuver-handler.js  [.js]  532 bytes
\module\ui\movement\movement-panel-updater.js  [.js]  1,378 bytes
\module\ui\movement\movement-phase-dispatcher.js  [.js]  912 bytes
\module\ui\movement\movement-phase-service.js  [.js]  2,047 bytes
\packs\accessories.db  [.db]  0 bytes
\packs\armor.db  [.db]  0 bytes
\packs\chassis.db  [.db]  0 bytes
\packs\maneuvers.db  [.db]  0 bytes
\packs\powerplants  []  0 bytes
\packs\suspension.db  [.db]  0 bytes
\packs\tires.db  [.db]  0 bytes
\packs\vehicles.db  [.db]  0 bytes
\packs\weapons.db  [.db]  0 bytes
\styles\carwars.css  [.css]  9,236 bytes
\styles\sheets.css  [.css]  868 bytes
\templates\actor\driver-sheet.html  [.html]  567 bytes
\templates\actor\vehicle-sheet.html  [.html]  3,474 bytes
\templates\actor\partials\armor-panel.html  [.html]  945 bytes
\templates\actor\partials\construction-panel.html  [.html]  1,226 bytes
\templates\actor\partials\crew-panel.html  [.html]  2,935 bytes
\templates\actor\partials\engine-panel.html  [.html]  0 bytes
\templates\actor\partials\hazard-display.html  [.html]  1,226 bytes
\templates\actor\partials\hc-tracker.html  [.html]  736 bytes
\templates\actor\partials\movement-panel.html  [.html]  6,801 bytes
\templates\actor\partials\speed-control.html  [.html]  992 bytes
\templates\actor\partials\systems-panel.html  [.html]  5,123 bytes
\templates\actor\partials\validation-panel.html  [.html]  1,229 bytes
\templates\actor\partials\weapon-panel.html  [.html]  2,198 bytes
\templates\actor\partials\weapon-summary.html  [.html]  723 bytes
\templates\chat\control-roll-card.html  [.html]  0 bytes
\templates\chat\maneuver-card.html  [.html]  0 bytes
\templates\item\accessory-sheet.html  [.html]  0 bytes
\templates\item\armor-sheet.html  [.html]  0 bytes
\templates\item\powerplant-sheet.html  [.html]  0 bytes
\templates\item\suspension-sheet.html  [.html]  0 bytes
\templates\item\tire-sheet.html  [.html]  0 bytes
\templates\item\weapon-sheet.html  [.html]  0 bytes

============================================================
JAVASCRIPT MODULES (imports, exports, hooks, classes)

------------------------------------------------------------
FILE: \module\actor\actor-sheet.js
------------------------------------------------------------

  >>> PATTERN: export 
     export class CarWarsVehicleSheet extends ActorSheet {
     export class CarWarsDriverSheet extends ActorSheet {

  >>> PATTERN: class 
     export class CarWarsVehicleSheet extends ActorSheet {
     export class CarWarsDriverSheet extends ActorSheet {

  >>> PATTERN: game\.
     const engine = game.carwars?.construction ?? game.carwarsConstruction ?? null;
     const engine = game.carwars?.movement ?? game.carwarsMovement ?? null;
     const engine = game.carwars?.movement ?? game.carwarsMovement ?? null;
     const engine = game.carwars?.movement ?? game.carwarsMovement ?? null;
     const helper = game.carwars?.turningKey ?? game.carwarsTurningKey ?? null;
     const helper = game.carwars?.turningKey ?? game.carwarsTurningKey ?? null;
     const engine = game.carwars?.armor ?? game.carwarsArmor ?? null;
     const engine = game.carwars?.armor ?? game.carwarsArmor ?? null;
     const engine = game.carwars?.weapons ?? game.carwarsWeapons ?? null;
     const engine = game.carwars?.weapons ?? game.carwarsWeapons ?? null;
     const engine = game.carwars?.crew ?? game.carwarsCrew ?? null;
     const engine = game.carwars?.systems ?? game.carwarsSystems ?? null;

  >>> PATTERN: ui\.
     ui.notifications?.error("Car Wars construction preview failed.");
     ui.notifications?.warn("No construction changes to apply.");
     ui.notifications?.info("Construction applied.");
     ui.notifications?.error("Failed to apply construction.");
     ui.notifications?.error("Movement control failed.");
     ui.notifications?.error("Maneuver selection failed.");
     ui.notifications?.error("Perform maneuver failed.");
     ui.notifications?.warn("Turning Key tool unavailable.");
     if (!token) return ui.notifications.warn("Select a vehicle token first.");
     ui.notifications?.error("Turning Key action failed.");
     if (!token) return ui.notifications.warn("Select a vehicle token first.");
     ui.notifications?.error("Turning Key tile spawn failed.");
     ui.notifications?.error("Turning Key tile clear failed.");
     ui.notifications?.error("Armor damage failed.");
     ui.notifications?.error("Armor repair failed.");
     ui.notifications?.error("Weapon fire failed.");
     ui.notifications?.error("Weapon reload failed.");
     ui.notifications?.error("Crew action failed.");
     ui.notifications?.error("System toggle failed.");
     ui.notifications.info(`Driver action: ${action}`);

  >>> PATTERN: canvas\.
     const token = this.token ?? canvas.tokens.controlled[0];
     const token = this.token ?? canvas.tokens.controlled[0];

  >>> PATTERN: foundry\.
     return foundry.utils.mergeObject(super.defaultOptions, {
     const expanded = foundry.utils.expandObject(Object.fromEntries(formData));
     const currentSystem = foundry.utils.deepClone(this.actor.system ?? {});
     const preview = foundry.utils.mergeObject(
     return foundry.utils.mergeObject(super.defaultOptions, {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
/**
 * Car Wars ActorSheet implementations
 * - CarWarsVehicleSheet: full multi-tab vehicle sheet with construction preview plumbing
 * - CarWarsDriverSheet: minimal driver sheet
 */

export class CarWarsVehicleSheet extends ActorSheet {

  constructor(...args) {
    super(...args);
    this.preview = null; // construction preview
  }

  /** Default sheet options */
  static get defaultOptions() {
    return foundry.utils.mergeObject(super.defaultOptions, {
      classes: ["carwars", "sheet", "vehicle"],
      template: "systems/carwars-system/templates/actor/vehicle-sheet.html",

      width: 900,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    return this.options.template;
  }

  getData(options = {}) {
    const data = super.getData(options);
    data.actorData = data.actor?.data ?? {};
    data.system = this.actor.system ?? {};
    return data;
  }

  activateListeners(html) {
    super.activateListeners(html);
    if (!this.isEditable) return;

    html.find(".driver-action").on("click", (ev) => {
      const action = ev.currentTarget.dataset.action;
      ui.notifications.info(`Driver action: ${action}`);
    });
  }
}

------------------------------------------------------------
FILE: \module\actor\armor-init.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import armorCatalog from "../../data/armor.json" assert { type: "json" };

  >>> PATTERN: export 
     export function initializeArmorDP(vehicle) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/actor/armor-init.js
import armorCatalog from "../../data/armor.json" assert { type: "json" };

/**
 * RAW Car Wars DP-per-point mapping.
 * Your armor.json does NOT include DP values, so we derive them here.
 */
const DP_PER_POINT = {
  "normal": 1,
  "fp": 1,
  "lr": 1,
  "lrfp": 1,
  "rp": 1,
  "rpfp": 1,
  "metal": 2,
  "lr-metal": 2
};

/**
 * Debug toggle — set to true to enable verbose logging.
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      );
    }
  }

  if (DEBUG) console.groupEnd();
}

// ------------------------------------------------------------
// Helper: deep equality for optimization
// ------------------------------------------------------------
function deepEqual(a, b) {
  return JSON.stringify(a) === JSON.stringify(b);
}

// ------------------------------------------------------------
// Helper: capitalize
// ------------------------------------------------------------
function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

------------------------------------------------------------
FILE: \module\actor\base-actor.js
------------------------------------------------------------

  >>> PATTERN: export 
     export class CarWarsActor extends Actor {

  >>> PATTERN: class 
     export class CarWarsActor extends Actor {

  >>> FILE SNIPPET:
export class CarWarsActor extends Actor {
  prepareBaseData() {
    super.prepareBaseData();
  }

  prepareDerivedData() {
    super.prepareDerivedData();
  }
}

------------------------------------------------------------
FILE: \module\actor\driver-data.js
------------------------------------------------------------

  >>> PATTERN: export 
     export class CarWarsDriverDataModel extends foundry.abstract.DataModel {

  >>> PATTERN: class 
     export class CarWarsDriverDataModel extends foundry.abstract.DataModel {

  >>> PATTERN: foundry\.
     export class CarWarsDriverDataModel extends foundry.abstract.DataModel {
     name: new foundry.data.fields.StringField({ required: true, initial: "" }),
     skillLevel: new foundry.data.fields.NumberField({ required: true, initial: 1 }),
     notes: new foundry.data.fields.StringField({ initial: "" })

  >>> FILE SNIPPET:
// module/actor/driver-data.js

export class CarWarsDriverDataModel extends foundry.abstract.DataModel {
  static defineSchema() {
    return {
      name: new foundry.data.fields.StringField({ required: true, initial: "" }),
      skillLevel: new foundry.data.fields.NumberField({ required: true, initial: 1 }),
      notes: new foundry.data.fields.StringField({ initial: "" })
    };
  }
}

------------------------------------------------------------
FILE: \module\actor\register-sheets.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { CarWarsVehicleSheet, CarWarsDriverSheet } from "./actor-sheet.js";

  >>> PATTERN: export 
     export function registerActorSheets() {

  >>> PATTERN: foundry\.
     const ActorSheetV13 = foundry.appv1.sheets.ActorSheet;
     const ActorsV13     = foundry.documents.collections.Actors;

  >>> FILE SNIPPET:
// module/actor/register-sheets.js
// Registers custom actor sheets for Car Wars system

import { CarWarsVehicleSheet, CarWarsDriverSheet } from "./actor-sheet.js";

// v13+ namespaces
const ActorSheetV13 = foundry.appv1.sheets.ActorSheet;
const ActorsV13     = foundry.documents.collections.Actors;

/**
 * Register all custom actor sheets for the Car Wars system.
 */
export function registerActorSheets() {

  // Unregister Foundry's default sheet
  ActorsV13.unregisterSheet("core", ActorSheetV13);

  // Register vehicle sheet
  ActorsV13.registerSheet("carwars-system", CarWarsVehicleSheet, {
    label: "CarWars Vehicle Sheet",
    types: ["vehicle"],
    makeDefault: true
  });

  // Register driver sheet
  ActorsV13.registerSheet("carwars-system", CarWarsDriverSheet, {
    label: "CarWars Driver Sheet",
    types: ["driver"],
    makeDefault: true
  });
}

------------------------------------------------------------
FILE: \module\actor\vehicle-data.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { RuleEngine } from "../rules/rule-engine.js";
     import { validateVehicle } from "../construction/validation/index.js";
     import { CatalogLoader } from "../construction/catalog-loader.js";

  >>> PATTERN: export 
     export class CarWarsVehicleDataModel extends foundry.abstract.DataModel {

  >>> PATTERN: class 
     export class CarWarsVehicleDataModel extends foundry.abstract.DataModel {

  >>> PATTERN: foundry\.
     export class CarWarsVehicleDataModel extends foundry.abstract.DataModel {
     } = foundry.data.fields;

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/actor/vehicle-data.js

import { RuleEngine } from "../rules/rule-engine.js";
import { validateVehicle } from "../construction/validation/index.js";
import { CatalogLoader } from "../construction/catalog-loader.js";

export class CarWarsVehicleDataModel extends foundry.abstract.DataModel {
  static defineSchema() {
    const {
      StringField,
      NumberField,
      ArrayField,
      SchemaField,
      BooleanField
    } = foundry.data.fields;

    return {

      // ============================================================
      // VEHICLE TYPE (car, cycle, trike, truck, tractor, trailer, bus, rv, copter)
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    this.performance.accelLimit = results.accel ?? 0;
    this.performance.decelLimit = results.decel ?? 0;
    this.performance.weightCapacity = results.maxWeight ?? 0;
    this.performance.spaceCapacity = results.totalSpaces ?? 0;

    // Validation
    const catalogs = CatalogLoader.getAll();
    const validation = validateVehicle(this, catalogs);
    this.validation = validation;

    // Movement reset at phase 1
    if (this.movement.phase === 1) {
      this.movement.hazards = 0;
    }

    // Skid detection
    this.movement.isSkidding =
      this.movement.hazards > this.movement.currentHC;
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\index.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { validateBody } from "./validate-body.js";
     import { validateChassis } from "./validate-chassis.js";
     import { validateSuspension } from "./validate-suspension.js";
     import { validateArmor } from "./validate-armor.js";
     import { validateWeapons } from "./validate-weapons.js";
     import { validateAccessories } from "./validate-accessories.js";
     import { validatePowerplant } from "./validate-powerplant.js";
     import { validateGasTank } from "./validate-gas-tank.js";
     import { validateTires } from "./validate-tires.js";
     import { validateSpaces } from "./validate-spaces.js";
     import { validateWeight } from "./validate-weight.js";
     import { validatePerformance } from "./validate-performance.js";
     import { validateCrew } from "./validate-crew.js";
     import { validateInternal } from "./validate-internal.js";

  >>> PATTERN: export 
     export function validateVehicle(vehicle, catalogs) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// index.js
// Orchestrator for the modular validation system.
// Each validator populates messages.errors, messages.warnings, messages.info.
//

import { validateBody } from "./validate-body.js";
import { validateChassis } from "./validate-chassis.js";
import { validateSuspension } from "./validate-suspension.js";
import { validateArmor } from "./validate-armor.js";
import { validateWeapons } from "./validate-weapons.js";
import { validateAccessories } from "./validate-accessories.js";
import { validatePowerplant } from "./validate-powerplant.js";
import { validateGasTank } from "./validate-gas-tank.js";
import { validateTires } from "./validate-tires.js";
import { validateSpaces } from "./validate-spaces.js";
import { validateWeight } from "./validate-weight.js";
import { validatePerformance } from "./validate-performance.js";
import { validateCrew } from "./validate-crew.js";
import { validateInternal } from "./validate-internal.js";
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  // Protection
  validateArmor(vehicle, catalogs, messages);

  // Payload
  validateWeapons(vehicle, catalogs, messages);
  validateAccessories(vehicle, catalogs, messages);
  validateCrew(vehicle, catalogs, messages);

  // Global constraints
  validateSpaces(vehicle, catalogs, messages);
  validateWeight(vehicle, catalogs, messages);

  // Dynamics
  validatePerformance(vehicle, catalogs, messages);

  // Internal systems
  validateInternal(vehicle, catalogs, messages);

  return messages;
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-accessories.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateAccessories(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-accessories.js
// Full validation for ACCESSORIES, SPECIAL RULES, SPACE/WEIGHT/COST SANITY
//

export function validateAccessories(vehicle, catalogs, messages) {
  const accessories = vehicle.accessories ?? [];
  const body = catalogs.bodies[vehicle.bodyId];

  if (!body) {
    messages.errors.push(`Cannot validate accessories: body '${vehicle.bodyId}' does not exist.`);
    return;
  }

  // ------------------------------------------------------------
  // 1. No accessories? That's allowed.
  // ------------------------------------------------------------
  if (accessories.length === 0) {
    messages.info.push(`Vehicle has no accessories installed.`);
    return;
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  }

  // ------------------------------------------------------------
  // Component Armor (Accessory version)
  // ------------------------------------------------------------
  if (name.includes("component armor")) {
    messages.info.push(
      `Component Armor: max 20 lbs per space; cost/weight vary by armor type.`
    );
  }

  // ------------------------------------------------------------
  // Wheelguards / Hubs (Accessory version)
  // ------------------------------------------------------------
  if (name.includes("wheelguard") || name.includes("wheel hub")) {
    messages.info.push(
      `Wheelguards/Hubs: must match armor type; max 40 lbs per wheel.`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-armor.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateArmor(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-armor.js
// Full validation for ARMOR, COMPONENT ARMOR, WHEELGUARDS, WHEELHUBS, RAMPLATE
//

export function validateArmor(vehicle, catalogs, messages) {
  const armorType = vehicle.armor?.type;
  const armorCatalog = catalogs.armor[armorType];
  const body = catalogs.bodies[vehicle.bodyId];
  const bodyMod = vehicle.bodyModId ? catalogs.bodyMods[vehicle.bodyModId] : null;

  // ------------------------------------------------------------
  // 1. Armor type must exist
  // ------------------------------------------------------------
  if (!armorCatalog) {
    messages.errors.push(`Armor type '${armorType}' does not exist.`);
    return;
  }

  // ------------------------------------------------------------
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      `Composite armor: cost/weight based on plastic underneath.`
    );
  }

  // ------------------------------------------------------------
  // 12. DP sanity check
  // ------------------------------------------------------------
  const dpPerPoint = armorCatalog.dpPerPoint ?? 1;

  for (const facing of facings) {
    const pts = vehicle.armor[facing] ?? 0;
    const dp = pts * dpPerPoint;

    if (dp < 0) {
      messages.errors.push(
        `DP for ${facing} armor is negative (${dp}).`
      );
    }
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-body.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateBody(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-body.js
// Full validation for BODY + BODY MODS
//

export function validateBody(vehicle, catalogs, messages) {
  const bodyId = vehicle.bodyId;
  const bodyModId = vehicle.bodyModId;

  const body = catalogs.bodies[bodyId];
  const bodyMod = bodyModId ? catalogs.bodyMods[bodyModId] : null;

  // ------------------------------------------------------------
  // 1. Body must exist
  // ------------------------------------------------------------
  if (!body) {
    messages.errors.push(`Selected body '${bodyId}' does not exist.`);
    return;
  }

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  // ------------------------------------------------------------
  // 13. Body mod multipliers sanity check
  // ------------------------------------------------------------
  if (bodyMod) {
    const multipliers = [
      "costMultiplier",
      "weightMultiplier",
      "armorCostMultiplier",
      "armorWeightMultiplier"
    ];

    for (const m of multipliers) {
      if (bodyMod[m] !== undefined && bodyMod[m] <= 0) {
        messages.errors.push(
          `Body mod '${bodyMod.name}' has invalid multiplier '${m}' (${bodyMod[m]}).`
        );
      }
    }
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-chassis.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateChassis(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-chassis.js
// Full validation for CHASSIS rules
//

export function validateChassis(vehicle, catalogs, messages) {
  const chassisId = vehicle.chassisId;
  const bodyId = vehicle.bodyId;

  const chassis = catalogs.chassis[chassisId];
  const body = catalogs.bodies[bodyId];

  // ------------------------------------------------------------
  // 1. Chassis must exist
  // ------------------------------------------------------------
  if (!chassis) {
    messages.errors.push(`Selected chassis '${chassisId}' does not exist.`);
    return;
  }

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      }
    }
  }

  // ------------------------------------------------------------
  // 11. Sanity checks for multipliers
  // ------------------------------------------------------------
  const multipliers = [
    "maxWeightMultiplier",
    "costMultiplier"
  ];

  for (const m of multipliers) {
    if (chassis[m] !== undefined && chassis[m] <= 0) {
      messages.errors.push(
        `Chassis '${chassis.name}' has invalid multiplier '${m}' (${chassis[m]}).`
      );
    }
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-crew.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateCrew(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-crew.js
// Full validation for CREW, POSITIONS, CONTROLS, WEIGHT, SPACE, BODY RULES
//

export function validateCrew(vehicle, catalogs, messages) {
  const body = catalogs.bodies[vehicle.bodyId];
  const crew = vehicle.crew ?? {};

  if (!body) {
    messages.errors.push(`Cannot validate crew: body '${vehicle.bodyId}' does not exist.`);
    return;
  }

  // ------------------------------------------------------------
  // 1. Driver is mandatory
  // ------------------------------------------------------------
  if (!crew.driver) {
    messages.errors.push(`Vehicle must have a driver.`);
    return; // cannot validate further without a driver
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  }
}

function validateCrewFireRules(vehicle, crew, messages) {
  const accessories = vehicle.accessories ?? [];
  const hasFE = accessories.some(a => a.itemId === "fire-extinguisher");
  const hasIFE = accessories.some(a => a.itemId === "improved-fire-extinguisher");

  if (!hasFE && !hasIFE) {
    messages.warnings.push(
      `Crew has no fire suppression — fire cannot be controlled.`
    );
  }

  if (crew.driver?.armor <= 0) {
    messages.warnings.push(
      `Driver has no personal armor — high risk in fire or breach.`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-gas-tank.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateGasTank(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-gas-tank.js
// Full validation for GAS TANKS, CAPACITY, WEIGHT, COST, ENGINE COMPATIBILITY
//

export function validateGasTank(vehicle, catalogs, messages) {
  const tankId = vehicle.gasTankId;
  const ppId = vehicle.powerPlantId;

  const tank = catalogs.gasTanks[tankId];
  const pp = catalogs.powerplants[ppId];
  const body = catalogs.bodies[vehicle.bodyId];

  // ------------------------------------------------------------
  // 1. If no gas tank is selected
  // ------------------------------------------------------------
  if (!tankId) {
    if (pp?.type === "gas") {
      messages.errors.push(`Gas engines require a gas tank.`);
    }
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      `Gas tank '${tank.name}' may only be used with economy engines.`
    );
  }

  // Heavy-duty tanks
  if (tank.specialRules?.includes("heavy-duty") &&
      !pp.specialRules?.includes("heavy-duty")) {
    messages.errors.push(
      `Gas tank '${tank.name}' requires a heavy-duty engine.`
    );
  }

  // Racing tanks
  if (tank.specialRules?.includes("racing") &&
      !pp.specialRules?.includes("racing")) {
    messages.errors.push(
      `Gas tank '${tank.name}' requires a racing engine.`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-internal.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateInternal(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-internal.js
// Full validation for INTERNAL SYSTEMS, COMPONENT ARMOR, FIRE, EXPLOSIONS, INTERNAL DP
//

export function validateInternal(vehicle, catalogs, messages) {
  const body = catalogs.bodies[vehicle.bodyId];
  const pp = catalogs.powerplants[vehicle.powerPlantId];
  const tank = catalogs.gasTanks[vehicle.gasTankId];

  if (!body) {
    messages.errors.push(`Cannot validate internal systems: body '${vehicle.bodyId}' does not exist.`);
    return;
  }

  // ------------------------------------------------------------
  // 1. Component Armor legality
  // ------------------------------------------------------------
  validateComponentArmor(vehicle, catalogs, messages);

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
}

function validateInternalComponents(vehicle, messages) {
  const crew = vehicle.crew ?? {};

  // Driver required
  if (!crew.driver) {
    messages.errors.push(`Vehicle must have a driver.`);
  }

  // Gunner optional but must be valid if present
  if (crew.gunner && crew.gunner.weight <= 0) {
    messages.errors.push(`Gunner weight must be > 0.`);
  }

  // Controls
  if (!vehicle.internal?.controls) {
    messages.errors.push(`Vehicle must have driver controls.`);
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-performance.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validatePerformance(vehicle, catalogs, messages) {

  >>> PATTERN: class 
     // 5. Compute Handling Class (HC)

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-performance.js
// Full validation for ACCELERATION, TOP SPEED, HC, HAZARDS, PF, MODIFIERS
//

export function validatePerformance(vehicle, catalogs, messages) {
  const body = catalogs.bodies[vehicle.bodyId];
  const suspension = catalogs.suspension[vehicle.suspensionId];
  const tire = catalogs.tires[vehicle.tireId];
  const pp = catalogs.powerplants[vehicle.powerPlantId];
  const engineMods = vehicle.engineMods ?? [];
  const accessories = vehicle.accessories ?? [];

  if (!body || !suspension || !tire || !pp) {
    messages.errors.push(`Cannot validate performance: missing body, suspension, tire, or power plant.`);
    return;
  }

  // ------------------------------------------------------------
  // 1. Compute PF (power factor)
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  if (hasSpoiler && hasAirdam) {
    hc += 1; // RAW: HC +1 when both installed
  }

  return hc;
}

function computeHazardModifier(tire, accessories) {
  let mod = tire.hazardModifier ?? 0;

  // HD shocks reduce all road hazards by D1
  const hasHDShocks = accessories.some(a => a.itemId === "hd-shocks");
  if (hasHDShocks) mod -= 1;

  // Anti-lock brakes reduce braking hazards by D1
  const hasABS = accessories.some(a => a.itemId === "anti-lock-brakes");
  if (hasABS) mod -= 1;

  return mod;
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-powerplant.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validatePowerplant(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-powerplant.js
// Full validation for POWER PLANTS, ENGINE MODS, PF, ACCEL, TOP SPEED, MPG
//

export function validatePowerplant(vehicle, catalogs, messages) {
  const ppId = vehicle.powerPlantId;
  const pp = catalogs.powerplants[ppId];

  const body = catalogs.bodies[vehicle.bodyId];
  const engineMods = vehicle.engineMods ?? [];

  // ------------------------------------------------------------
  // 1. Power plant must exist
  // ------------------------------------------------------------
  if (!pp) {
    messages.errors.push(`Power plant '${ppId}' does not exist.`);
    return;
  }

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  let mpg = pp.baseMPG;

  for (const mod of engineMods) {
    if (mod.mpgModifier) {
      mpg += mod.mpgModifier;
    }
  }

  return mpg;
}

function validatePowerplantBodyRestrictions(pp, body, messages) {
  if (!pp.allowedBodyCategories) return;

  if (!pp.allowedBodyCategories.includes(body.category)) {
    messages.errors.push(
      `Power plant '${pp.name}' cannot be installed in body type '${body.category}'.`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-spaces.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateSpaces(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-spaces.js
// Full validation for SPACE USAGE across all subsystems
//

export function validateSpaces(vehicle, catalogs, messages) {
  const body = catalogs.bodies[vehicle.bodyId];
  const bodyMod = vehicle.bodyModId ? catalogs.bodyMods[vehicle.bodyModId] : null;

  if (!body) {
    messages.errors.push(`Cannot validate spaces: body '${vehicle.bodyId}' does not exist.`);
    return;
  }

  // ------------------------------------------------------------
  // 1. Compute total spaces available (body + body mods)
  // ------------------------------------------------------------
  let totalSpaces = body.spaces ?? 0;

  if (bodyMod?.spaceModifier) {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  for (const key of Object.keys(turrets)) {
    const t = turrets[key];
    total += t.spacesUsed ?? 0;
  }

  return total;
}

function computeCupolaSpaces(vehicle) {
  const cupolas = vehicle.cupolas ?? {};
  let total = 0;

  for (const key of Object.keys(cupolas)) {
    const c = cupolas[key];
    total += c.spacesUsed ?? 0;
  }

  return total;
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-suspension.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateSuspension(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-suspension.js
// Full validation for SUSPENSION rules
//

export function validateSuspension(vehicle, catalogs, messages) {
  const suspensionId = vehicle.suspensionId;
  const bodyId = vehicle.bodyId;

  const suspension = catalogs.suspension[suspensionId];
  const body = catalogs.bodies[bodyId];

  // ------------------------------------------------------------
  // 1. Suspension must exist
  // ------------------------------------------------------------
  if (!suspension) {
    messages.errors.push(`Selected suspension '${suspensionId}' does not exist.`);
    return;
  }

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  // 10. Future-proofing for special vehicle types
  // ------------------------------------------------------------
  if (["boat", "hovercraft", "helicopter"].includes(body.category)) {
    messages.info.push(
      `Body '${body.name}' is a special vehicle type. Suspension '${suspension.name}' may require additional rules.`
    );
  }

  // ------------------------------------------------------------
  // 11. Sanity check: suspension must not reduce HC below RAW minimum
  // ------------------------------------------------------------
  const baseHC = body.baseHC ?? 0;
  const hcTotal = baseHC + (suspension.hcModifier ?? 0);

  if (hcTotal < -6) {
    messages.warnings.push(
      `Suspension '${suspension.name}' reduces HC below RAW minimum (-6).`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-tires.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateTires(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-tires.js
// Full validation for TIRES, TIRE OPTIONS, WHEELGUARDS, WHEELHUBS
//

export function validateTires(vehicle, catalogs, messages) {
  const tireId = vehicle.tireId;
  const tire = catalogs.tires[tireId];

  const body = catalogs.bodies[vehicle.bodyId];
  const tireOptions = vehicle.tireOptions ?? [];
  const wheelguards = vehicle.armor?.wheelguards ?? [];
  const wheelhubs = vehicle.armor?.wheelhubs ?? [];

  const wheelCount = vehicle.wheelCount ?? 0;

  // ------------------------------------------------------------
  // 1. Tire type must exist
  // ------------------------------------------------------------
  if (!tire) {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      );
    }

    if (wh > 40) {
      messages.errors.push(
        `Wheelhub on wheel ${i + 1} exceeds max weight (40 lbs).`
      );
    }
  }
}

function validateTireBodyRestrictions(tire, body, messages) {
  if (!tire.allowedBodyCategories) return;

  if (!tire.allowedBodyCategories.includes(body.category)) {
    messages.errors.push(
      `Tire type '${tire.name}' cannot be installed on body type '${body.category}'.`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-vehicle.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { validateBody } from "./validate-body.js";
     import { validateChassis } from "./validate-chassis.js";
     import { validateSuspension } from "./validate-suspension.js";
     import { validateArmor } from "./validate-armor.js";
     import { validateWeapons } from "./validate-weapons.js";
     import { validateAccessories } from "./validate-accessories.js";
     import { validatePowerplant } from "./validate-powerplant.js";
     import { validateGasTank } from "./validate-gas-tank.js";
     import { validateTires } from "./validate-tires.js";
     import { validateSpaces } from "./validate-spaces.js";
     import { validateWeight } from "./validate-weight.js";
     import { validatePerformance } from "./validate-performance.js";
     import { validateInternal } from "./validate-internal.js";
     import { validateCrew } from "./validate-crew.js";

  >>> PATTERN: export 
     export function validateVehicle(vehicle, catalogs) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-vehicle.js
// Master vehicle validator: orchestrates all subsystem validators
//

import { validateBody } from "./validate-body.js";
import { validateChassis } from "./validate-chassis.js";
import { validateSuspension } from "./validate-suspension.js";
import { validateArmor } from "./validate-armor.js";
import { validateWeapons } from "./validate-weapons.js";
import { validateAccessories } from "./validate-accessories.js";
import { validatePowerplant } from "./validate-powerplant.js";
import { validateGasTank } from "./validate-gas-tank.js";
import { validateTires } from "./validate-tires.js";
import { validateSpaces } from "./validate-spaces.js";
import { validateWeight } from "./validate-weight.js";
import { validatePerformance } from "./validate-performance.js";
import { validateInternal } from "./validate-internal.js";
import { validateCrew } from "./validate-crew.js";

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
 * Wrap a validator call to prevent one failure from killing the whole run.
 */
function safeCall(fn, messages) {
  try {
    fn();
  } catch (err) {
    messages.errors.push(
      `Internal validation error: ${err instanceof Error ? err.message : String(err)}`
    );
  }
}

/**
 * Remove duplicate messages while preserving type and order as much as possible.
 */
function dedupeMessages(messages) {
  messages.errors = Array.from(new Set(messages.errors));
  messages.warnings = Array.from(new Set(messages.warnings));
  messages.info = Array.from(new Set(messages.info));
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-weapons.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateWeapons(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-weapons.js
// Full validation for WEAPONS, AMMO, MOUNTS, TURRETS, CUPOLAS, EWPs, LINKS
//

export function validateWeapons(vehicle, catalogs, messages) {
  const weapons = vehicle.weapons ?? [];
  const body = catalogs.bodies[vehicle.bodyId];

  // ------------------------------------------------------------
  // 1. No weapons? That's allowed.
  // ------------------------------------------------------------
  if (weapons.length === 0) {
    messages.info.push(`Vehicle has no weapons installed.`);
    return;
  }

  // ------------------------------------------------------------
  // 2. Validate each weapon entry
  // ------------------------------------------------------------
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
}

function validateWeaponCountLimits(vehicle, catalogs, messages) {
  const body = catalogs.bodies[vehicle.bodyId];
  const weapons = vehicle.weapons ?? [];

  if (!body) return;

  if (body.category === "cycle" && weapons.length > 2) {
    messages.errors.push(
      `Cycles may mount at most 2 weapons.`
    );
  }

  if (body.category === "trike" && weapons.length > 3) {
    messages.errors.push(
      `Trikes may mount at most 3 weapons.`
    );
  }
}

------------------------------------------------------------
FILE: \module\construction\validation\validate-weight.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateWeight(vehicle, catalogs, messages) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
//
// validate-weight.js
// Full validation for WEIGHT across all subsystems
//

export function validateWeight(vehicle, catalogs, messages) {
  const body = catalogs.bodies[vehicle.bodyId];
  const chassis = catalogs.chassis[vehicle.chassisId];
  const bodyMod = vehicle.bodyModId ? catalogs.bodyMods[vehicle.bodyModId] : null;

  if (!body || !chassis) {
    messages.errors.push(`Cannot validate weight: missing body or chassis.`);
    return;
  }

  // ------------------------------------------------------------
  // 1. Compute max weight (body × chassis multiplier)
  // ------------------------------------------------------------
  let maxWeight = body.maxWeight ?? 0;

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

function computeCupolaWeight(vehicle) {
  const cupolas = vehicle.cupolas ?? {};
  let total = 0;

  for (const key of Object.keys(cupolas)) {
    total += cupolas[key].weight ?? 0;
  }

  return total;
}

function computeTireWeight(vehicle, catalogs) {
  const tire = catalogs.tires[vehicle.tireId];
  const wheelCount = vehicle.wheelCount ?? 0;

  if (!tire) return 0;

  return tire.weight * wheelCount;
}

------------------------------------------------------------
FILE: \module\construction\armor-calculator.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\construction\catalog-loader.js
------------------------------------------------------------

  >>> PATTERN: export 
     export const CatalogLoader = {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// ------------------------------------------------------------
// CATALOG LOADER — Full Catalog Integration with Preload (v1.1)
// ------------------------------------------------------------

function log(msg, ...args) {
  const ts = new Date().toISOString().split("T")[1].replace("Z", "");
  console.log(`🟪 [carwars ${ts}] CatalogLoader: ${msg}`, ...args);
}

export const CatalogLoader = {
  _cache: {},

  // ------------------------------------------------------------
  // Load a single catalog file (safe)
  // ------------------------------------------------------------
  async _loadFile(path) {
    try {
      log(`Loading catalog: ${path}`);
      const response = await fetch(path);
      if (!response.ok) {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  get(name) {
    return this._cache[name] ?? {};
  },

  // ------------------------------------------------------------
  // Get all catalogs
  // ------------------------------------------------------------
  getAll() {
    return this._cache;
  },

  // ------------------------------------------------------------
  // Force reload
  // ------------------------------------------------------------
  async reload() {
    log("Reloading all catalogs…");
    this._cache = {};
    return await this.loadAll();
  }
};

------------------------------------------------------------
FILE: \module\construction\chassis.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\construction\derived-stats.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\construction\load-calculator.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\construction\validation.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function validateVehicleConstruction(vehicle, catalogs) {

  >>> PATTERN: foundry\.
     * This module is intentionally pure and decoupled from Foundry.

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/construction/validation.js

/**
 * Core construction validation for a single vehicle.
 *
 * This module is intentionally pure and decoupled from Foundry.
 * You pass in plain JS data objects; it returns an array of error strings.
 *
 * Later, your Actor logic can adapt Foundry data into this format.
 */

/**
 * @typedef {Object} VehicleInput
 * @property {string} id               - Vehicle ID (optional, for logging)
 * @property {number} totalWeight      - Fully loaded vehicle weight (lbs)
 * @property {number} wheelCount       - Number of wheels actually mounted
 * @property {string} bodyId           - ID of the selected body
 * @property {string} chassisId        - ID of the selected chassis
 * @property {string} bodyModId        - ID of the selected body-mod (optional)
 */
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  // --- Rule 5: Special case for pickups/vans/campers over 5500 lbs ---------

  if (
    (body.category === "pickup" || body.category === "van" || body.category === "camper") &&
    vehicle.totalWeight > 5500 &&
    chassis.id !== "extra-heavy"
  ) {
    errors.push(
      `Pickups, vans, and campers over 5500 lbs must use an Extra-Heavy chassis.`
    );
  }

  // --- Future: Body-mod-specific rules (placeholder) ------------------------

  // Example hook:
  // if (bodyMod) { ...additional validations here... }

  return errors;
}

------------------------------------------------------------
FILE: \module\helpers\template-loader.js
------------------------------------------------------------

  >>> PATTERN: export 
     export async function loadTemplates(paths) {

  >>> FILE SNIPPET:
export async function loadTemplates(paths) {
  if (typeof globalThis.loadTemplate !== "function") {
    throw new Error("loadTemplate is not available in this context.");
  }
  return Promise.all(paths.map(path => globalThis.loadTemplate(path)));
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\collision-flow.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { detectCollisions } from '../movement-api.js';
     import { resolveCollision } from '../movement-api.js';

  >>> PATTERN: export 
     export function runCollisionFlow(actor, movementState) {
     // Additional export required by importers
     export { detectCollisions };

  >>> FILE SNIPPET:
// module/movement/orchestrator/collision-flow.js
// Function: Runs collision detection and collision resolution, returning all collision outcomes.

import { detectCollisions } from '../movement-api.js';
import { resolveCollision } from '../movement-api.js';

export function runCollisionFlow(actor, movementState) {
  const detected = detectCollisions(actor, movementState);

  const collisions = [];
  for (const collision of detected) {
    const resolved = resolveCollision(actor, collision);
    collisions.push(resolved);
  }

  return {
    collisions
  };
}

// Additional export required by importers
export { detectCollisions };

------------------------------------------------------------
FILE: \module\movement\orchestrator\control-flow.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { computeControlRoll } from '../movement-api.js';

  >>> PATTERN: export 
     export function runControlFlow(actor, movementState, hazardState) {

  >>> FILE SNIPPET:
// module/movement/orchestrator/control-flow.js
// Function: Determines if a control roll is required and prepares the roll request object.

import { computeControlRoll } from '../movement-api.js';

export function runControlFlow(actor, movementState, hazardState) {
  const control = computeControlRoll(actor, movementState, hazardState);

  return {
    required: control.required,
    target: control.target,
    modifier: control.modifier,
    difficulty: control.difficulty,
    reason: control.reason
  };
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\crash-flow.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runCrashTable } from '../movement-api.js';

  >>> PATTERN: export 
     export function runCrashFlow(actor, movementState, collisionResult) {

  >>> FILE SNIPPET:
// module/movement/orchestrator/crash-flow.js
// Function: Runs Crash Table logic (skids, rolls, fishtails, vaults) after collisions and hazards.

import { runCrashTable } from '../movement-api.js';

export function runCrashFlow(actor, movementState, collisionResult) {
  // crash-router returns: { type, details, newFacing, newSpeed, position }
  const crash = runCrashTable(actor, movementState, collisionResult);

  return {
    type: crash.type,
    details: crash.details,
    newFacing: crash.newFacing,
    newSpeed: crash.newSpeed,
    position: crash.position
  };
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\hazard-flow.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { applyHazards } from '../movement-api.js';

  >>> PATTERN: export 
     export function runHazardFlow(actor, movementState) {

  >>> FILE SNIPPET:
// module/movement/orchestrator/hazard-flow.js
// Function: Applies the hazard engine and computes HC changes after the maneuver.

import { applyHazards } from '../movement-api.js';

export function runHazardFlow(actor, movementState) {
  // Hazard engine returns: { hazardsApplied, newHC, totalHazard }
  const hazardResult = applyHazards(actor, movementState);

  return {
    hazardsApplied: hazardResult.hazardsApplied,
    totalHazard: hazardResult.totalHazard,
    newHC: hazardResult.newHC
  };
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\index.js
------------------------------------------------------------

  >>> PATTERN: export 
     export { runMovementPhase } from "./orchestrator/index.js";
     export { runMovementPhaseForUI } from "./movement-phase-ui-adapter.js";
     export { runMovementEngine } from "./movement-engine.js";
     export { applyHazards } from "./hazard-engine.js";
     export { runControlRoll } from "./control-engine.js";
     export { resolveCollision } from "./collision-engine.js";
     export { runCrashTable } from "./crash-router.js";

  >>> FILE SNIPPET:
// module/movement/index.js
// Public interface for the entire movement subsystem.

// Orchestrator (Phase 3) + UI Adapter (Phase 5)
export { runMovementPhase } from "./orchestrator/index.js";
export { runMovementPhaseForUI } from "./movement-phase-ui-adapter.js";

// Movement Engine (core movement logic)
export { runMovementEngine } from "./movement-engine.js";

// Hazard Engine (hazard application + HC changes)
export { applyHazards } from "./hazard-engine.js";

// Control Roll Engine (control table + modifiers)
export { runControlRoll } from "./control-engine.js";

// Collision Engine (collision resolution + damage routing)
export { resolveCollision } from "./collision-engine.js";

// Crash Router (skids, rolls, fishtails, vaults)
export { runCrashTable } from "./crash-router.js";

------------------------------------------------------------
FILE: \module\movement\orchestrator\maneuver-flow.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { getManeuverById } from '../movement-api.js';
     import { performManeuver } from '../movement-api.js';

  >>> PATTERN: export 
     export async function runManeuverFlow(actor, maneuverId) {

  >>> FILE SNIPPET:
// module/movement/orchestrator/maneuver-flow.js
// Function: Looks up the maneuver and produces the initial movement state.

import { getManeuverById } from '../movement-api.js';
import { performManeuver } from '../movement-api.js';

export async function runManeuverFlow(actor, maneuverId) {
  const maneuver = getManeuverById(maneuverId);
  if (!maneuver) {
    return {
      maneuver: null,
      movementState: {
        speed: actor.system.speed,
        facing: actor.system.facing,
        position: actor.system.position
      }
    };
  }

  const speed = actor.system.movement?.lastSpeed ?? 0;

  const movementState = await performManeuver(actor, maneuverId, speed);

  return {
    maneuver,
    movementState
  };
}


------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-flow.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runMovementEngine } from '../movement-api.js';

  >>> PATTERN: export 
     export function runMovementFlow(actor, movementState) {
     * This is the missing export flagged by the audit:
     export function executeMovementPhase(actor, movementState) {

  >>> PATTERN: ui\.
     * Pure delegation. No state mutation. No UI. No dice.

  >>> FILE SNIPPET:
// module/movement/orchestrator/movement-flow.js
// Function: Wraps the movement engine for orchestrator use.

import { runMovementEngine } from '../movement-api.js';

/**
 * Phase‑3 orchestrator wrapper for movement engine.
 * Pure delegation. No state mutation. No UI. No dice.
 */
export function runMovementFlow(actor, movementState) {
  // Movement engine returns: { path, distance, newState, notes }
  const movementResult = runMovementEngine(actor, movementState);

  return {
    path: movementResult.path,
    distance: movementResult.distance,
    newState: movementResult.newState,
    notes: movementResult.notes || null
  };
}

/**
 * Phase‑3 orchestrator entry point expected by UI and dispatcher.
 * This is the missing export flagged by the audit:
 *   executeMovementPhase → used in maneuver-handler.js
 *
 * It simply delegates to runMovementFlow.
 */
export function executeMovementPhase(actor, movementState) {
  return runMovementFlow(actor, movementState);
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-orchestrator.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runManeuverFlow } from '../movement-api.js';
     import { runHazardFlow } from '../movement-api.js';
     import { runControlFlow } from '../movement-api.js';
     import { runCollisionFlow } from '../movement-api.js';
     import { runCrashFlow } from '../movement-api.js';

  >>> PATTERN: export 
     export async function runMovementPhase(actor, maneuverId) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/orchestrator/movement-orchestrator.js
// Function: Top-level orchestrator that runs a full movement phase using pure logic modules.

import { runManeuverFlow } from '../movement-api.js';
import { runHazardFlow } from '../movement-api.js';
import { runControlFlow } from '../movement-api.js';
import { runCollisionFlow } from '../movement-api.js';
import { runCrashFlow } from '../movement-api.js';

export async function runMovementPhase(actor, maneuverId) {
  const result = {
    maneuver: null,
    movement: null,
    hazards: null,
    control: null,
    collisions: [],
    crash: null,
    finalState: null
  };

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  result.control = controlResult;

  // Step 4: Collision detection + resolution
  const collisionResult = runCollisionFlow(actor, result.movement);
  result.collisions = collisionResult.collisions;

  // Step 5: Crash table (skids, rolls, fishtails, vaults)
  const crashResult = runCrashFlow(actor, result.movement, collisionResult);
  result.crash = crashResult;

  // Final state after all adjustments
  result.finalState = {
    speed: result.movement.speed,
    facing: result.movement.facing,
    hc: result.hazards.newHC,
    position: result.movement.position
  };

  return result;
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-phase-orchestrator.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runManeuverFlow } from '../movement-api.js';
     import { runMovementFlow } from '../movement-api.js';
     import { runHazardFlow } from '../movement-api.js';
     import { runControlFlow } from '../movement-api.js';
     import { runCollisionFlow } from '../movement-api.js';
     import { runCrashFlow } from '../movement-api.js';
     import { createMovementPhaseResult } from '../movement-api.js';
     import { validateMovementPhaseResult } from '../movement-api.js';

  >>> PATTERN: export 
     export async function runMovementPhase(actor, movementState) {
     } export { runMovementPhase };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/orchestrator/movement-phase-orchestrator.js
// Master orchestrator for a full movement phase.

import { runManeuverFlow } from '../movement-api.js';
import { runMovementFlow } from '../movement-api.js';
import { runHazardFlow } from '../movement-api.js';
import { runControlFlow } from '../movement-api.js';
import { runCollisionFlow } from '../movement-api.js';
import { runCrashFlow } from '../movement-api.js';

import { createMovementPhaseResult } from '../movement-api.js';
import { validateMovementPhaseResult } from '../movement-api.js';

export async function runMovementPhase(actor, movementState) {
  const result = createMovementPhaseResult();

  // 1. Maneuver
  result.maneuver = runManeuverFlow(actor, movementState);

  // 2. Movement
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  result.collisions = collisionResult.collisions;

  // 6. Crash Table (if any)
  result.crash = runCrashFlow(actor, movementState, collisionResult);

  // 7. Final State
  result.finalState.speed = movementState.speed;
  result.finalState.facing = movementState.facing;
  result.finalState.hc = movementState.hc;
  result.finalState.position = movementState.position;

  // 8. Validation
  const validation = validateMovementPhaseResult(result);
  if (!validation.valid) {
    console.warn("Movement Phase Result Validation Errors:", validation.errors);
  }

  return result;
} export { runMovementPhase };


------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-phase-result.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function createMovementPhaseResult() {

  >>> FILE SNIPPET:
// module/movement/orchestrator/movement-phase-result.js
// Function: Defines the unified result object schema for a full movement phase.

export function createMovementPhaseResult() {
  return {
    maneuver: null,
    movement: null,
    hazards: null,
    control: null,
    collisions: [],
    crash: null,
    finalState: {
      speed: null,
      facing: null,
      hc: null,
      position: null
    }
  };
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-phase-schema.js
------------------------------------------------------------

  >>> PATTERN: export 
     export const MovementPhaseSchema = {

  >>> FILE SNIPPET:
// module/movement/orchestrator/movement-phase-schema.js
// Function: Defines a static schema for validating movement-phase results.

export const MovementPhaseSchema = {
  type: "object",
  required: [
    "maneuver",
    "movement",
    "hazards",
    "control",
    "collisions",
    "crash",
    "finalState"
  ],
  properties: {
    maneuver: { type: ["object", "null"] },
    movement: { type: ["object", "null"] },
    hazards: { type: ["object", "null"] },
    control: { type: ["object", "null"] },
    collisions: {
      type: "array",
      items: { type: "object" }
    },
    crash: { type: ["object", "null"] },
    finalState: {
      type: "object",
      required: ["speed", "facing", "hc", "position"],
      properties: {
        speed: { type: ["number", "null"] },
        facing: { type: ["number", "null"] },
        hc: { type: ["number", "null"] },
        position: { type: ["object", "null"] }
      }
    }
  }
};

------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-phase-ui-adapter.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runMovementPhase } from '../movement-api.js';

  >>> PATTERN: export 
     export async function runMovementPhaseForUI(actor, movementState) {

  >>> PATTERN: ui\.
     // Adapter: Normalizes orchestrator output for Phase 4 UI.

  >>> FILE SNIPPET:
// module/movement/orchestrator/movement-phase-ui-adapter.js
// Adapter: Normalizes orchestrator output for Phase 4 UI.

import { runMovementPhase } from '../movement-api.js';

export async function runMovementPhaseForUI(actor, movementState) {
  const result = await runMovementPhase(actor, movementState);

  return {
    maneuver: result.maneuver,
    movement: result.movement,
    hazards: result.hazards,
    control: result.control,
    collisions: result.collisions,
    crash: result.crash,
    finalState: result.finalState
  };
}

------------------------------------------------------------
FILE: \module\movement\orchestrator\movement-phase-validator.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { MovementPhaseSchema } from '../movement-api.js';

  >>> PATTERN: export 
     export function validateMovementPhaseResult(result) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/orchestrator/movement-phase-validator.js
// Function: Validates a movement-phase result object against the schema.

import { MovementPhaseSchema } from '../movement-api.js';

export function validateMovementPhaseResult(result) {
  const errors = [];

  // Helper: check type
  function checkType(path, value, expected) {
    const types = Array.isArray(expected) ? expected : [expected];
    const actual = value === null ? "null" : typeof value;
    if (!types.includes(actual)) {
      errors.push(`${path} expected type ${types.join(" or ")}, got ${actual}`);
    }
  }

  // Validate top-level required fields
  for (const field of MovementPhaseSchema.required) {
    if (!(field in result)) {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    const fs = result.finalState;
    const requiredFS = MovementPhaseSchema.properties.finalState.required;

    for (const field of requiredFS) {
      if (!(field in fs)) {
        errors.push(`finalState missing required field: ${field}`);
      }
    }

    checkType("finalState.speed", fs.speed, ["number", "null"]);
    checkType("finalState.facing", fs.facing, ["number", "null"]);
    checkType("finalState.hc", fs.hc, ["number", "null"]);
    checkType("finalState.position", fs.position, ["object", "null"]);
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

------------------------------------------------------------
FILE: \module\movement\armor-damage-router.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function resolveArmorDamage(vehicle, { facing, damage, isCollision = false }) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/armor-damage-router.js
// ------------------------------------------------------------
// Car Wars Deluxe — Armor Damage Router (Phase 2)
// Pure logic only. Computes how damage *would* be applied.
// Does NOT modify actor data.
// ------------------------------------------------------------

export function resolveArmorDamage(vehicle, { facing, damage, isCollision = false }) {
  const sys = vehicle.system;

  const outcome = {
    type: "armor-damage",
    facing,
    incoming: damage,

    ramplate: { applied: 0, remaining: null, destroyed: false },
    wheelguards: { applied: 0 },
    wheelhubs: { applied: 0 },

    armor: { applied: 0, remaining: null, breached: false },
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  }

  // ------------------------------------------------------------
  // 5. INTERNAL DAMAGE (overflow)
  // ------------------------------------------------------------
  if (remaining > 0) {
    outcome.overflow = remaining;
    outcome.internalDamage.push({
      amount: remaining,
      note: "Overflow damage (internal routing not implemented in Phase 2)."
    });
  }

  return outcome;
}

// ------------------------------------------------------------
function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

------------------------------------------------------------
FILE: \module\movement\bootlegger-template.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { inchesToPixels } from "./movement-engine.js";

  >>> PATTERN: export 
     export class BootleggerTemplate {

  >>> PATTERN: class 
     export class BootleggerTemplate {

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: canvas\.
     const startX = actor.token.x + canvas.grid.size / 2;
     const startY = actor.token.y + canvas.grid.size / 2;
     return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
     const templates = canvas.templates.placeables.filter(t =>
     return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/bootlegger-template.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Bootlegger Reverse Templates
// Draws the 180° arc used for bootlegger reverses.
// ------------------------------------------------------------

import { inchesToPixels } from "./movement-engine.js";

export class BootleggerTemplate {
  /**
   * Create a bootlegger reverse template.
   * @param {Actor} actor
   * @param {Object} maneuver - maneuver definition from ManeuverRegistry
   *   Expected fields:
   *   - direction: "left" or "right"
   */
  static createFor(actor, maneuver) {
    if (!actor.token) return;

    const startX = actor.token.x + canvas.grid.size / 2;
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

    if (!templates.length) return;
    const ids = templates.map(t => t.id);
    return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);
  }

  /**
   * Compute the center point of the bootlegger arc.
   */
  static _computeTurnCenter(x, y, facing, radiusPx, direction) {
    const offsetAngle =
      facing + (direction === "left" ? -90 : 90);
    const angleRad = offsetAngle * (Math.PI / 180);

    return {
      x: x + Math.cos(angleRad) * radiusPx,
      y: y + Math.sin(angleRad) * radiusPx
    };
  }
}

------------------------------------------------------------
FILE: \module\movement\collision-detection.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function tokensOverlap(tokenA, tokenB) {
     export function computeImpactAngle(tokenA, tokenB) {
     export function determineImpactPoint(tokenA, impactAngle) {
     export function computeRelativeSpeeds(actorA, actorB) {
     export function detectCollision(tokenA, tokenB) {
     export const detectCollisions = detectCollision;

  >>> PATTERN: canvas\.
     const ax2 = tokenA.x + tokenA.width * canvas.grid.size;
     const ay2 = tokenA.y + tokenA.height * canvas.grid.size;
     const bx2 = tokenB.x + tokenB.width * canvas.grid.size;
     const by2 = tokenB.y + tokenB.height * canvas.grid.size;
     x: tokenA.x + (tokenA.width * canvas.grid.size) / 2,
     y: tokenA.y + (tokenA.height * canvas.grid.size) / 2
     x: tokenB.x + (tokenB.width * canvas.grid.size) / 2,
     y: tokenB.y + (tokenB.height * canvas.grid.size) / 2

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/collision-detection.js
// ------------------------------------------------------------
// Car Wars Deluxe — Collision Detection (Phase 2)
// Pure logic only:
// - Detects bounding-box collisions between tokens
// - Computes impact angle
// - Computes impact point (front, rear, left, right)
// - Computes relative speed vectors
// - Produces a structured collisionEvent object
// ------------------------------------------------------------

/**
 * Check if two tokens overlap (bounding-box collision).
 */
export function tokensOverlap(tokenA, tokenB) {
  const ax1 = tokenA.x;
  const ay1 = tokenA.y;
  const ax2 = tokenA.x + tokenA.width * canvas.grid.size;
  const ay2 = tokenA.y + tokenA.height * canvas.grid.size;

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  const { speedA, speedB } = computeRelativeSpeeds(actorA, actorB);

  return {
    actorA,
    actorB,
    tokenA,
    tokenB,
    angle,
    impactPointA,
    impactPointB,
    speedA,
    speedB,
    massA: actorA.system.weight ?? 1,
    massB: actorB.system.weight ?? 1
  };
}

// Alias for orchestrator compatibility
export const detectCollisions = detectCollision;

------------------------------------------------------------
FILE: \module\movement\collision-engine.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { resolveCollisionType } from "./collision-type.js";
     import { getDamageModifier } from "./damage-modifier.js";
     import { getTemporarySpeed } from "./temporary-speed.js";

  >>> PATTERN: export 
     export function resolveCollision({
     // Additional export required by importers
     export { getDamageModifier };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/collision-engine.js
// ------------------------------------------------------------
// Car Wars Deluxe — Collision Engine (Phase 2)
// Pure logic only. No actor updates, no chat, no dice.
// ------------------------------------------------------------

import { resolveCollisionType } from "./collision-type.js";
import { getDamageModifier } from "./damage-modifier.js";
import { getTemporarySpeed } from "./temporary-speed.js";

/**
 * Compute a collision outcome (pure logic).
 */
export function resolveCollision({
  attacker,
  defender,
  type,
  attackerSpeed,
  defenderSpeed = 0,
  baseDamage
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      return {
        attackerFinalSpeed: V1,
        defenderFinalSpeed: V2
      };

    case "fixed":
      return {
        attackerFinalSpeed: 0,
        defenderFinalSpeed: 0
      };

    default:
      return { attackerFinalSpeed: V1, defenderFinalSpeed: V2 };
  }
}

// ------------------------------------------------------------
// Additional export required by importers
// ------------------------------------------------------------
export { getDamageModifier };

------------------------------------------------------------
FILE: \module\movement\collision-physics.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { resolveSpinout } from "./spinout.js";

  >>> PATTERN: export 
     export async function resolveCollisionPhysics(collisionType, event) {
     // Additional export required by importers
     export { resolveCollisionPhysics as computeCollisionPhysics };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/collision-physics.js
// ------------------------------------------------------------
// Car Wars Deluxe — Collision Physics (Phase 2)
// Pure logic only:
// - Computes RAW collision forces
// - Determines damage zones
// - Determines skid/spinout/roll/vault triggers
// - Returns structured collision outcomes
// - Does NOT update actor state
// - Does NOT rotate tokens
// - Does NOT apply armor damage
// - Does NOT post chat messages
// ------------------------------------------------------------

import { resolveSpinout } from "./spinout.js";

/**
 * Compute relative impact speed.
 * RAW: use the difference in speeds for head-on,
 *      use the striking vehicle's speed for rear-end,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        isSpinout: false
      };
  }

  // ------------------------------------------------------------
  // Phase 2: return structured outcome only
  // ------------------------------------------------------------
  return {
    collisionType,
    relativeSpeed,
    impactForce,
    controlLoss: controlLoss.type,
    controlOutcome
  };
}

// ------------------------------------------------------------
// Additional export required by importers
// ------------------------------------------------------------
export { resolveCollisionPhysics as computeCollisionPhysics };

------------------------------------------------------------
FILE: \module\movement\collision-router.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { determineCollisionType } from "./collision-type.js";
     import { resolveCollisionPhysics } from "./collision-physics.js";

  >>> PATTERN: export 
     export async function routeCollision(collisionEvent) {
     export { determineCollisionType, resolveCollisionPhysics };

  >>> PATTERN: ui\.
     *   Structured collision result for movement-state + Phase 4 UI.

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/collision-router.js
// ------------------------------------------------------------
// Car Wars Deluxe — Collision Router (Phase 2)
// Pure logic only:
// - Accepts a collision event
// - Determines collision type
// - Routes to the correct collision physics module
// - Returns a structured collision outcome
// - Does NOT update actor state
// - Does NOT rotate tokens
// - Does NOT apply armor damage
// - Does NOT post chat messages
// ------------------------------------------------------------

import { determineCollisionType } from "./collision-type.js";
import { resolveCollisionPhysics } from "./collision-physics.js";

/**
 * Route a collision event to the correct collision physics handler.
 *
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  // Phase 2: DO NOT update actor or token here.
  // Movement state + UI will handle:
  // - armor damage
  // - tire damage
  // - token rotation
  // - chat messages
  // - templates
  // ------------------------------------------------------------

  return {
    type: "collision",
    collisionType,
    ...collisionOutcome
  };
}

// ------------------------------------------------------------
// Additional exports required by importers
// ------------------------------------------------------------
export { determineCollisionType, resolveCollisionPhysics };

------------------------------------------------------------
FILE: \module\movement\collision-type.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function resolveCollisionType({
     // Additional export required by importers
     export { resolveCollisionType as determineCollisionType };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/collision-type.js
// ------------------------------------------------------------
// Car Wars Deluxe — Collision Type Router
// Computes RAW collision speed + impact facings for:
//   - head-on
//   - rear-end
//   - t-bone
//   - sideswipe (same direction)
//   - sideswipe (opposite direction)
//   - fixed object
// ------------------------------------------------------------

/**
 * Resolve collision type into:
 *  - collisionSpeed (RAW formula)
 *  - attackerFacingHit
 *  - defenderFacingHit
 *
 * This does NOT compute damage or crash tables.
 * That is handled by collision-engine.js.
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      break;

    default:
      throw new Error(`Unknown collision type: ${type}`);
  }

  return {
    type,
    collisionSpeed,
    attackerFacingHit,
    defenderFacingHit,
    attackerSpeed,
    defenderSpeed
  };
}

// ------------------------------------------------------------
// Additional export required by importers
// ------------------------------------------------------------
export { resolveCollisionType as determineCollisionType };

------------------------------------------------------------
FILE: \module\movement\conforming.js
------------------------------------------------------------

  >>> PATTERN: export 
     export async function recordConformingPair(primaryToken, secondaryToken, data = {}) {
     export async function clearConformingForToken(token) {
     export function isConformingPair(primaryToken, secondaryToken) {
     export function shouldSkipCollisionDueToConforming(tokenA, tokenB) {
     export async function slideAlongPrimary(primaryToken, secondaryToken, { gridSteps = 1 } = {}) {
     export async function pivotToClear(primaryToken, secondaryToken, opts = {}) {
     export async function updateConformingState(primaryToken, secondaryToken) {
     export function tokensAreTouching(tokenA, tokenB) {
     * Provide named export for modules expecting getConformingInfo.
     export function getConformingInfo(token) {

  >>> PATTERN: game\.
     startedAtRound: game.round ?? 0,

  >>> PATTERN: canvas\.
     const ax2 = tokenA.x + tokenA.width * canvas.grid.size;
     const ay2 = tokenA.y + tokenA.height * canvas.grid.size;
     const bx2 = tokenB.x + tokenB.width * canvas.grid.size;
     const by2 = tokenB.y + tokenB.height * canvas.grid.size;

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/conforming.js
// ------------------------------------------------------------
// Car Wars Deluxe — Conforming Movement (Phase 2)
// ------------------------------------------------------------

const FLAG_SCOPE = "carwars";
const FLAG_KEY = "conforming";

/**
 * Mark secondaryToken as conforming to primaryToken.
 */
export async function recordConformingPair(primaryToken, secondaryToken, data = {}) {
  if (!primaryToken || !secondaryToken) return;

  const updated = {
    primaryId: primaryToken.id,
    type: data.type ?? "unknown",
    startedAtRound: game.round ?? 0,
    sceneId: primaryToken.parent?.id ?? null
  };
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  const bx1 = tokenB.x;
  const by1 = tokenB.y;
  const bx2 = tokenB.x + tokenB.width * canvas.grid.size;
  const by2 = tokenB.y + tokenB.height * canvas.grid.size;

  return (
    ax1 < bx2 &&
    ax2 > bx1 &&
    ay1 < by2 &&
    ay2 > by1
  );
}

/**
 * Provide named export for modules expecting getConformingInfo.
 */
export function getConformingInfo(token) {
  if (!token) return null;
  return token.getFlag(FLAG_SCOPE, FLAG_KEY) ?? null;
}

------------------------------------------------------------
FILE: \module\movement\control-table.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function getControlModifier(speed, hs) {
     export function computeControlRoll({ speed, difficulty, handlingStatus }) {
     * Provide named export for modules expecting applyControlRoll.
     export const applyControlRoll = computeControlRoll;

  >>> PATTERN: ui\.
     // No dice, no actor updates, no UI.

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/control-table.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — RAW Control Table (Phase 2)
// Pure logic: computes control modifier and control roll target.
// No dice, no actor updates, no UI.
// ------------------------------------------------------------

const CONTROL_TABLE = [
  { min: 5, max: 10, values: { "3": "safe", "2": "safe", "1": "safe", "0": "safe", "-1": "safe", "-2": "safe", "-3": "safe", "-4": "safe", "-5": "safe", "-6": "safe" } },
  { min: 15, max: 20, values: { "3": "safe", "2": "safe", "1": "safe", "0": "safe", "-1": "safe", "-2": "safe", "-3": "safe", "-4": "safe", "-5": 2, "-6": 2 } },
  { min: 25, max: 30, values: { "3": "safe", "2": "safe", "1": "safe", "0": "safe", "-1": "safe", "-2": "safe", "-3": 2, "-4": 3, "-5": 4, "-6": 4 } },
  { min: 35, max: 40, values: { "3": "safe", "2": "safe", "1": "safe", "0": "safe", "-1": 2, "-2": 2, "-3": 3, "-4": 4, "-5": 5, "-6": 5 } },
  { min: 45, max: 50, values: { "3": "safe", "2": "safe", "1": "safe", "0": 2, "-1": 2, "-2": 3, "-3": 4, "-4": 5, "-5": 6, "-6": 6 } },
  { min: 55, max: 60, values: { "3": "safe", "2": "safe", "1": 2, "0": 2, "-1": 3, "-2": 4, "-3": 5, "-4": 6, "-5": "XX", "-6": "XX" } },
  { min: 65, max: 70, values: { "3": "safe", "2": 2, "1": 2, "0": 3, "-1": 4, "-2": 5, "-3": 6, "-4": "XX", "-5": "XX", "-6": "XX" } },
  { min: 75, max: 80, values: { "3": 2, "2": 2, "1": 3, "0": 4, "-1": 5, "-2": 6, "-3": "XX", "-4": "XX", "-5": "XX", "-6": "XX" } },
  { min: 85, max: 90, values: { "3": 2, "2": 3, "1": 4, "0": 5, "-1": 6, "-2": "XX", "-3": "XX", "-4": "XX", "-5": "XX", "-6": "XX" } },
  { min: 95, max: 100, values: { "3": 3, "2": 4, "1": 5, "0": 6, "-1": "XX", "-2": "XX", "-3": "XX", "-4": "XX", "-5": "XX", "-6": "XX" } },
  { min: 105, max: 110, values: { "3": 4, "2": 5, "1": 6, "0": "XX", "-1": "XX", "-2": "XX", "-3": "XX", "-4": "XX", "-5": "XX", "-6": "XX" } },
  { min: 115, max: 120, values: { "3": 5, "2": 6, "1": "XX", "0": "XX", "-1": "XX", "-2": "XX", "-3": "XX", "-4": "XX", "-5": "XX", "-6": "XX" } },
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  // Standard control roll
  const target = 7 + difficulty + modifier;

  return {
    requiresRoll: true,
    autoCrash: false,
    target,
    crashTable: 1,
    modifier,
    difficulty,
    handlingStatus,
    speed
  };
}

/**
 * Provide named export for modules expecting applyControlRoll.
 */
export const applyControlRoll = computeControlRoll;

------------------------------------------------------------
FILE: \module\movement\crash-router.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { resolveCrashTable1 } from "./crash-table-1.js";
     import { resolveCrashTable2 } from "./crash-table-2.js";

  >>> PATTERN: export 
     export async function routeCrash(actor, controlResult) {
     export { resolveCrashTable1, resolveCrashTable2 };
     export function runCrashTable(actor, crashData) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/crash-router.js
// ------------------------------------------------------------
// Car Wars Deluxe — Crash Router (Phase 2)
// Pure logic only:
// - Routes to Crash Table 1 or 2
// - Returns structured crash outcome
// - Does NOT update actor state
// - Does NOT rotate tokens
// - Does NOT post chat messages
// ------------------------------------------------------------

import { resolveCrashTable1 } from "./crash-table-1.js";
import { resolveCrashTable2 } from "./crash-table-2.js";

/**
 * Route a failed control roll to the correct crash table.
 *
 * @param {Actor} actor
 * @param {object} controlResult
 * @returns {object} crashOutcome
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      crashOutcome = {
        type: "unknown-table",
        table,
        controlResult
      };
  }

  // Phase 2: DO NOT update actor or token here.
  // Movement state is updated by control-rolls.js via updateMovementState().

  return crashOutcome;
}

// ------------------------------------------------------------
// Additional exports required by importers
// ------------------------------------------------------------
export { resolveCrashTable1, resolveCrashTable2 };
export function runCrashTable(actor, crashData) {
  return resolveCrashTable(actor, crashData);
}

------------------------------------------------------------
FILE: \module\movement\crash-table-1.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { resolveSkid } from "./skid-physics.js";
     import { resolveRoll } from "./roll-physics.js";
     import { resolveVault } from "./vault-physics.js";

  >>> PATTERN: export 
     export async function resolveCrashTable1(actor, controlResult, maneuverType = "") {
     export { resolveSkid, resolveRoll, resolveVault };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/crash-table-1.js
// ------------------------------------------------------------
// Car Wars Deluxe — Crash Table 1 Resolver (Phase 2)
// Handles skids (1–4), rolls (5–9), and vaults (10+).
// Uses margin of failure from the control roll.
// ------------------------------------------------------------

import { resolveSkid } from "./skid-physics.js";
import { resolveRoll } from "./roll-physics.js";
import { resolveVault } from "./vault-physics.js";

/**
 * Resolve Crash Table 1 result.
 * @param {Actor} actor
 * @param {object} controlResult - from control-rolls.js
 * @param {string} maneuverType - optional: used for vault flip logic
 * @returns {object} crashOutcome
 */
export async function resolveCrashTable1(actor, controlResult, maneuverType = "") {
  // RAW: Crash severity is based on margin of failure
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  // ------------------------------------------------------------
  // Fallback (should never happen)
  // ------------------------------------------------------------
  ChatMessage.create({
    speaker: { alias: actor.name },
    content: `⚠️ Crash Table 1: Unexpected margin value <b>${value}</b>.`
  });

  return {
    type: "unknown",
    table: 1,
    margin: value
  };
}

// ------------------------------------------------------------
// Additional exports required by importers
// ------------------------------------------------------------
export { resolveSkid, resolveRoll, resolveVault };

------------------------------------------------------------
FILE: \module\movement\crash-table-2.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { resolveFishtail } from "./fishtail-physics.js";
     import { resolveCrashTable1 } from "./crash-table-1.js";

  >>> PATTERN: export 
     export async function resolveCrashTable2(actor, controlResult) {
     export { resolveFishtail, resolveCrashTable1 };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/crash-table-2.js
// ------------------------------------------------------------
// Car Wars Deluxe — Crash Table 2 Resolver (Phase 2)
// Handles fishtails (minor, major, and escalations to Crash Table 1).
// Uses margin of failure from the control roll.
// ------------------------------------------------------------

import { resolveFishtail } from "./fishtail-physics.js";
import { resolveCrashTable1 } from "./crash-table-1.js";

/**
 * Resolve Crash Table 2 result.
 * @param {Actor} actor
 * @param {object} controlResult - from control-rolls.js
 * @returns {object} crashOutcome
 */
export async function resolveCrashTable2(actor, controlResult) {
  const margin = controlResult.margin ?? 0;

  ChatMessage.create({
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    }
  }

  // Major fishtails often cause speed loss (handled in fishtail-physics)
  if (outcome.temporarySpeed !== undefined) {
    updates["system.movement.temporarySpeed"] = outcome.temporarySpeed;
  }

  // Crash Table 1 escalation handles skid/spinout state
  if (Object.keys(updates).length > 0) {
    await actor.update(updates);
  }

  return crashOutcome;
}

// ------------------------------------------------------------
// Additional exports required by importers
// ------------------------------------------------------------
export { resolveFishtail, resolveCrashTable1 };

------------------------------------------------------------
FILE: \module\movement\damage-modifier.js
------------------------------------------------------------

  >>> PATTERN: export 
     // Default export contains the three functions.
     export function computeCollisionDamage(collision = {}, opts = {}) {
     export function applyArmorModifiers(damage, armor = 0, options = {}) {
     export function finalizeDamage(collision = {}, armor = 0, opts = {}) {
     // Default export for convenience
     export default {
     // Additional export required by importers
     export { finalizeDamage as getDamageModifier };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// damage-modifier.js
// Simple damage modifier module for CarWars movement/collision pipeline.
// Exports:
//   - computeCollisionDamage(collision): compute raw damage from collision data
//   - applyArmorModifiers(damage, armor): reduce damage by armor values
//   - finalizeDamage(collision, armor, options): full pipeline returning final damage object
// Default export contains the three functions.

const DEFAULT_OPTIONS = {
  // scale factor for converting kinetic energy to damage units
  kineticToDamage: 0.02,
  // minimum damage threshold (below this, treat as 0)
  minDamageThreshold: 0.5,
  // critical multiplier for head-on or high-angle collisions
  criticalSpeedThreshold: 30, // mph or units used by your engine
  criticalMultiplier: 1.5,
  // clamp final damage
  maxDamageCap: 1000
};

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  const armorResult = applyArmorModifiers(computeResult.rawDamage, armor, opts);
  const finalDamage = Math.max(0, armorResult.finalDamage);

  return {
    rawDamage: computeResult.rawDamage,
    armorResult,
    finalDamage,
    details: computeResult.details
  };
}

// Default export for convenience
export default {
  computeCollisionDamage,
  applyArmorModifiers,
  finalizeDamage
};

// Additional export required by importers
export { finalizeDamage as getDamageModifier };

------------------------------------------------------------
FILE: \module\movement\fishtail-physics.js
------------------------------------------------------------

  >>> PATTERN: export 
     export async function resolveFishtail(actor, value) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/fishtail-physics.js
// ------------------------------------------------------------
// Car Wars Deluxe — Fishtail Physics Engine (Phase 2)
// Handles Crash Table 2 — Fishtails.
// - Uses the control roll's margin (severity)
// - Does NOT roll dice (player-facing only)
// - Does NOT call Crash Table 1 directly
// - Returns a structured outcome for crash-table-2.js
// ------------------------------------------------------------

/**
 * Resolve a Crash Table 2 fishtail result.
 *
 * Crash Table 2 — Fishtails (RAW summary, in terms of severity):
 *  - -1, 0, 1, 2  → Minor fishtail (1 square), -3 to hit
 *  - 3, 4         → Major fishtail (2 squares), -6 to hit
 *  - 5            → Minor fishtail, then Crash Table 1, no auto fire
 *  - 6–9          → Major fishtail, then Crash Table 1, no auto fire
 *  - 10+          → Major + minor (3 squares total), then Crash Table 1, no auto fire
 *
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
          : "No further <b>automatic weapon fire</b> permitted from this vehicle this turn."
      }
    `
  });

   // ------------------------------------------------------------
  // Return structured outcome for Crash Table 2 resolver
  // ------------------------------------------------------------
  return {
    type: "fishtail",
    table: 2,
    severity: value,
    fishtailType,
    squares,
    direction,            // null for now — Phase 4 UI will set this
    weaponFlags,
    triggersCrashTable1,
    temporarySpeed: null  // placeholder; can be set by future physics rules
  };
}

------------------------------------------------------------
FILE: \module\movement\hazard-engine.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function computeHazard({
     export function sumHazards(...values) {
     export function applyHazards(actor, movementState) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/hazard-engine.js
// ------------------------------------------------------------
// Car Wars Deluxe — Hazard Engine (Phase 2)
// Pure logic only. Computes hazard accumulation and HC changes.
// ------------------------------------------------------------

/**
 * Compute hazard accumulation and resulting HC change.
 *
 * @param {object} opts
 * @param {number} opts.currentHC - current handling status (–6 to +3)
 * @param {number} [opts.maneuverHazard=0] - hazard from maneuver difficulty
 * @param {number} [opts.collisionHazard=0] - hazard from collision
 * @param {number} [opts.skidHazard=0] - hazard from skid/spinout
 * @param {number} [opts.otherHazard=0] - terrain, obstacles, etc.
 *
 * @returns {object} {
 *   totalHazard,
 *   newHC,
 *   deltaHC
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  const result = computeHazard({
    currentHC,
    maneuverHazard,
    collisionHazard,
    skidHazard,
    otherHazard
  });

  return {
    hazardsApplied: {
      maneuverHazard,
      collisionHazard,
      skidHazard,
      otherHazard
    },
    totalHazard: result.totalHazard,
    newHC: result.newHC
  };
}

------------------------------------------------------------
FILE: \module\movement\index.js
------------------------------------------------------------

  >>> PATTERN: export 
     export { runMovementPhase } from "./orchestrator/index.js";
     export { runMovementPhaseForUI } from "./movement-phase-ui-adapter.js";
     export { runMovementEngine } from "./movement-engine.js";
     export { applyHazards } from "./hazard-engine.js";
     export { runControlRoll } from "./control-engine.js";
     export { resolveCollision } from "./collision-engine.js";
     export { runCrashTable } from "./crash-router.js";

  >>> FILE SNIPPET:
// module/movement/index.js
// Public interface for the entire movement subsystem.

// Orchestrator (Phase 3) + UI Adapter (Phase 5)
export { runMovementPhase } from "./orchestrator/index.js";
export { runMovementPhaseForUI } from "./movement-phase-ui-adapter.js";

// Movement Engine (core movement logic)
export { runMovementEngine } from "./movement-engine.js";

// Hazard Engine (hazard application + HC changes)
export { applyHazards } from "./hazard-engine.js";

// Control Roll Engine (control table + modifiers)
export { runControlRoll } from "./control-engine.js";

// Collision Engine (collision resolution + damage routing)
export { resolveCollision } from "./collision-engine.js";

// Crash Router (skids, rolls, fishtails, vaults)
export { runCrashTable } from "./crash-router.js";

------------------------------------------------------------
FILE: \module\movement\lane-change-template.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { inchesToPixels, movementThisPhase } from "./movement-engine.js";

  >>> PATTERN: export 
     export class LaneChangeTemplate {

  >>> PATTERN: class 
     export class LaneChangeTemplate {

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: canvas\.
     const startX = actor.token.x + canvas.grid.size / 2;
     const startY = actor.token.y + canvas.grid.size / 2;
     distance: Math.sqrt((end.x - startX) ** 2 + (end.y - startY) ** 2) / canvas.grid.size,
     return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
     const templates = canvas.templates.placeables.filter(t =>
     return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/lane-change-template.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Lane Change Templates
// Shows the diagonal path of a 1" lateral shift.
// ------------------------------------------------------------

import { inchesToPixels, movementThisPhase } from "./movement-engine.js";

export class LaneChangeTemplate {
  /**
   * Create a lane change template.
   * @param {Actor} actor
   * @param {"left"|"right"} direction
   */
  static createFor(actor, direction) {
    if (!actor.token) return;

    const startX = actor.token.x + canvas.grid.size / 2;
    const startY = actor.token.y + canvas.grid.size / 2;
    const facing = actor.token.rotation || 0;
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  /**
   * Compute the end point of the lane change.
   */
  static computeEndPoint(x, y, facing, forwardPx, lateralPx) {
    const rad = facing * (Math.PI / 180);

    // Forward vector
    const fx = Math.cos(rad) * forwardPx;
    const fy = Math.sin(rad) * forwardPx;

    // Lateral vector (perpendicular to facing)
    const lx = Math.cos(rad + Math.PI / 2) * lateralPx;
    const ly = Math.sin(rad + Math.PI / 2) * lateralPx;

    return {
      x: x + fx + lx,
      y: y + fy + ly
    };
  }
}

------------------------------------------------------------
FILE: \module\movement\maneuver-registry.js
------------------------------------------------------------

  >>> PATTERN: export 
     export const MANEUVERS = {
     export function getManeuver(id) {
     export const getManeuverById = getManeuver;
     export function listManeuvers() {
     export const ManeuverRegistry = {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/maneuver-registry.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Maneuver Registry (Phase 2)
// Pure static data. No UI fields, no dynamic state.
// ------------------------------------------------------------

/**
 * Maneuver definitions (pure data):
 * - id: Unique identifier
 * - name: Display name
 * - difficulty: RAW difficulty (integer)
 * - footprint: inches of forward movement consumed
 * - type: maneuver category
 * - hazard: optional RAW hazard modifier
 *
 * Phase 2: No UI fields, no dynamic fields (e.g., direction).
 */

export const MANEUVERS = {
  drift: {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
 * Alias for getManeuver — used by modules expecting getManeuverById.
 */
export const getManeuverById = getManeuver;

/**
 * List all maneuvers as an array.
 */
export function listManeuvers() {
  return Object.values(MANEUVERS);
}

/**
 * Provide a registry object for modules expecting ManeuverRegistry.
 */
export const ManeuverRegistry = {
  MANEUVERS,
  getManeuver,
  getManeuverById,
  listManeuvers
};

------------------------------------------------------------
FILE: \module\movement\movement-api.js
------------------------------------------------------------

  >>> PATTERN: export 
     export { applyHazards } from "./hazard-engine.js";
     export { computeControlRoll } from "./control-table.js";
     export { createMovementPhaseResult } from "./orchestrator/movement-phase-result.js";
     export { detectCollisions } from "./collision-detection.js";
     export { getManeuverById } from "./maneuver-registry.js";
     export { MovementPhaseSchema } from "./orchestrator/movement-phase-schema.js";
     export { performManeuver } from "./perform-maneuver.js";
     export { resolveCollision } from "./collision-engine.js";
     export { runCollisionFlow } from "./orchestrator/collision-flow.js";
     export { runControlFlow } from "./orchestrator/control-flow.js";
     export { runCrashFlow } from "./orchestrator/crash-flow.js";
     export { runCrashTable } from "./crash-router.js";
     export { runHazardFlow } from "./orchestrator/hazard-flow.js";
     export { runManeuverFlow } from "./orchestrator/maneuver-flow.js";
     export { runMovementEngine } from "./movement-engine.js";
     export { runMovementFlow } from "./orchestrator/movement-flow.js";
     export { runMovementPhase } from "./orchestrator/movement-orchestrator.js";
     export { validateMovementPhaseResult } from "./orchestrator/movement-phase-validator.js";

  >>> FILE SNIPPET:
// AUTO-GENERATED — DO NOT EDIT
// Unified Movement API Layer
// ------------------------------------------------------------

export { applyHazards } from "./hazard-engine.js";
export { computeControlRoll } from "./control-table.js";
export { createMovementPhaseResult } from "./orchestrator/movement-phase-result.js";
export { detectCollisions } from "./collision-detection.js";
export { getManeuverById } from "./maneuver-registry.js";
export { MovementPhaseSchema } from "./orchestrator/movement-phase-schema.js";
export { performManeuver } from "./perform-maneuver.js";
export { resolveCollision } from "./collision-engine.js";
export { runCollisionFlow } from "./orchestrator/collision-flow.js";
export { runControlFlow } from "./orchestrator/control-flow.js";
export { runCrashFlow } from "./orchestrator/crash-flow.js";
export { runCrashTable } from "./crash-router.js";
export { runHazardFlow } from "./orchestrator/hazard-flow.js";
export { runManeuverFlow } from "./orchestrator/maneuver-flow.js";
export { runMovementEngine } from "./movement-engine.js";
export { runMovementFlow } from "./orchestrator/movement-flow.js";
export { runMovementPhase } from "./orchestrator/movement-orchestrator.js";
export { validateMovementPhaseResult } from "./orchestrator/movement-phase-validator.js";

------------------------------------------------------------
FILE: \module\movement\movement-engine.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { performManeuver } from "./perform-maneuver.js";
     import { MovementTemplate } from "./movement-template.js";
     import { LaneChangeTemplate } from "./lane-change-template.js";
     import { ManeuverRegistry } from "./maneuver-registry.js";
     import { SkidTemplate } from "./skid-template.js";
     import { TurnArcTemplate } from "./turn-arc-template.js";
     import { BootleggerTemplate } from "./bootlegger-template.js";
     import { SpinoutTemplate } from "./spinout-template.js";
     import {

  >>> PATTERN: export 
     export class MovementEngine {
     export function inchesPerTurn(speedMph) {
     export function inchesPerPhase(speedMph) {
     export function movementThisPhase(vehicle) {
     export function inchesToGridUnits(inches) {
     export function inchesToPixels(inches) {
     export function gridUnitsToInches(units) {
     export function pixelsToInches(px) {
     export async function runMovementEngine(actor, maneuverId) {

  >>> PATTERN: class 
     export class MovementEngine {

  >>> PATTERN: canvas\.
     const primary = canvas.tokens.get(conform.primaryId);
     const distancePerGrid = canvas.scene?.grid?.distance || 1;
     const distancePerGrid = canvas.scene?.grid?.distance || 1;
     const pixelsPerGrid = canvas.scene?.grid?.size || 100;
     const distancePerGrid = canvas.scene?.grid?.distance || 1;
     const pixelsPerGrid = canvas.scene?.grid?.size || 100;
     const distancePerGrid = canvas.scene?.grid?.distance || 1;

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/movement-engine.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Movement Engine (Phase 2)
// Pure logic orchestrator:
// - Handles conforming movement
// - Clears templates (Phase 4 will replace this)
// - Calls performManeuver()
// - Does NOT roll dice
// - Does NOT create templates
// - Does NOT rotate tokens
// - Does NOT post chat messages
// - Does NOT react to crash outcomes
// ------------------------------------------------------------

import { performManeuver } from "./perform-maneuver.js";
import { MovementTemplate } from "./movement-template.js";
import { LaneChangeTemplate } from "./lane-change-template.js";
import { ManeuverRegistry } from "./maneuver-registry.js";
import { SkidTemplate } from "./skid-template.js";
import { TurnArcTemplate } from "./turn-arc-template.js";
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  const pixelsPerGrid = canvas.scene?.grid?.size || 100;
  return (inches / distancePerGrid) * pixelsPerGrid;
}

export function gridUnitsToInches(units) {
  const distancePerGrid = canvas.scene?.grid?.distance || 1;
  return units * distancePerGrid;
}

export function pixelsToInches(px) {
  const pixelsPerGrid = canvas.scene?.grid?.size || 100;
  const distancePerGrid = canvas.scene?.grid?.distance || 1;
  const units = px / pixelsPerGrid;
  return units * distancePerGrid;
}

export async function runMovementEngine(actor, maneuverId) {
  const engine = new MovementEngine(actor);
  await engine.execute(maneuverId);
}

------------------------------------------------------------
FILE: \module\movement\movement-phase-ui-adapter.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runMovementPhase } from "./orchestrator/index.js";

  >>> PATTERN: export 
     export async function runMovementPhaseForUI(actor, movementState = {}) {

  >>> PATTERN: ui\.
     * @param {Object} movementState - Optional movement state overrides from the UI.

  >>> FILE SNIPPET:
// module/movement/movement-phase-ui-adapter.js
// Phase 5 UI Adapter — bridges UI → Orchestrator

import { runMovementPhase } from "./orchestrator/index.js";

/**
 * UI-friendly wrapper for running a movement phase.
 * The UI layer calls this instead of calling the orchestrator directly.
 *
 * @param {Actor} actor - The vehicle actor performing the movement.
 * @param {Object} movementState - Optional movement state overrides from the UI.
 * @returns {Promise<Object>} - The full movement phase result for the dispatcher.
 */
export async function runMovementPhaseForUI(actor, movementState = {}) {
  if (!actor) {
    console.error("runMovementPhaseForUI called without an actor");
    return { error: "No actor provided" };
  }

  // Pull the actor's current movement state from system data
  const baseState = actor.system?.movement ?? {};

  // Merge UI overrides (maneuver selection, speed changes, etc.)
  const state = {
    ...baseState,
    ...movementState,
    actorId: actor.id
  };

  // Call the orchestrator (Phase 3 core logic)
  const result = await runMovementPhase(actor, state);

  // Return the orchestrator result directly to the UI dispatcher
  return result;
}

------------------------------------------------------------
FILE: \module\movement\movement-state.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function computeMovementState(current = {}, data = {}) {
     export { computeMovementState as updateMovementState };

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/movement-state.js
// ------------------------------------------------------------
// Phase 2 — Central Movement State Manager (Pure Logic)
// Computes next movement state but does NOT update the actor.
// ------------------------------------------------------------

/**
 * Compute next movement state (pure logic).
 *
 * @param {object} current - current movement state (actor.system.movement)
 * @param {object} data - updates from maneuver/crash/etc.
 * @returns {object} new movement state
 */
export function computeMovementState(current = {}, data = {}) {
  const mv = structuredClone(current);

  // ------------------------------------------------------------
  // Spinout Recovery (RAW)
  // ------------------------------------------------------------
  if (mv.wasSpinoutLastPhase) {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  if (data.nextSpeed !== undefined) mv.nextSpeed = data.nextSpeed;
  if (data.temporarySpeed !== undefined) mv.temporarySpeed = data.temporarySpeed;

  // ------------------------------------------------------------
  // Track spinout for next phase
  // ------------------------------------------------------------
  mv.wasSpinoutLastPhase = mv.isSpinout === true;

  // ------------------------------------------------------------
  // Phase Advancement
  // ------------------------------------------------------------
  mv.phase = ((mv.phase ?? 0) % 10) + 1;

  return mv;
}

// ------------------------------------------------------------
// Named exports expected by other modules
// ------------------------------------------------------------
export { computeMovementState as updateMovementState };

------------------------------------------------------------
FILE: \module\movement\movement-template.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { inchesToPixels, movementThisPhase } from "./movement-engine.js";

  >>> PATTERN: export 
     export class MovementTemplate {
     export function hasValidToken(actor) {
     export const MovementTemplateStyle = {
     export function computeRotationOffset(actor) {
     export class SkidTemplate {
     export class TurnArcTemplate {

  >>> PATTERN: class 
     export class MovementTemplate {
     export class SkidTemplate {
     export class TurnArcTemplate {

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: canvas\.
     x: actor.token?.x + (canvas.grid.size / 2),
     y: actor.token?.y + (canvas.grid.size / 2),
     return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
     const templates = canvas.templates.placeables.filter(t =>
     return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);
     * without tokens on the canvas.

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/movement-template.js

import { inchesToPixels, movementThisPhase } from "./movement-engine.js";

export class MovementTemplate {
  static createFor(actor) {
    const distance = movementThisPhase(actor);
    const pixels = inchesToPixels(distance);

    const templateData = {
      t: "ray",
      user: game.user.id,
      distance,
      direction: actor.token?.rotation || 0,
      x: actor.token?.x + (canvas.grid.size / 2),
      y: actor.token?.y + (canvas.grid.size / 2),
      width: pixels,
      flags: {
        cw: {
          movement: true,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
/**
 * Future expansion: Skid template support.
 * This is a placeholder for when you implement skidding visuals.
 */
export class SkidTemplate {
  static createFor(actor) {
    // Placeholder for future skid arc or drift visualization.
    console.log("SkidTemplate.createFor() called — not implemented yet.");
  }
}

/**
 * Future expansion: Turn arc templates (D1, D2, D3 turns).
 */
export class TurnArcTemplate {
  static createFor(actor, maneuver) {
    // Placeholder for future turn arc visualization.
    console.log("TurnArcTemplate.createFor() called — not implemented yet.");
  }
}

------------------------------------------------------------
FILE: \module\movement\perform-maneuver.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { getManeuverById } from "./maneuver-registry.js";
     import { applyControlRoll } from "./control-table.js";
     import { updateMovementState } from "./movement-state.js";

  >>> PATTERN: export 
     export async function performManeuver(actor, maneuverId, speedMph) {
     export { performManeuver as executeManeuver };

  >>> PATTERN: ui\.
     ui.notifications.warn("Cycles cannot perform a bootlegger reverse.");
     ui.notifications.warn("Speed must be between 20 and 35 mph for a bootlegger reverse.");

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/perform-maneuver.js
// ------------------------------------------------------------
// RAW Car Wars Deluxe Edition — Maneuver Resolution (Phase 2)
// ------------------------------------------------------------

import { getManeuverById } from "./maneuver-registry.js";
import { applyControlRoll } from "./control-table.js";
import { updateMovementState } from "./movement-state.js";

/**
 * Perform a RAW maneuver.
 * Phase 2: This module DOES NOT:
 * - roll dice
 * - route crashes
 * - determine success/failure
 *
 * It ONLY:
 * - computes RAW hazard & handling
 * - computes control roll requirements
 * - stores a pending control roll in movement state
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  await updateMovementState(actor, {
    maneuver: maneuver.id ?? maneuver.maneuverId,
    difficulty: maneuver.difficulty ?? 0,
    hazard: totalHazard,
    speed: speedMph,
    newHandlingStatus,
    isSkidding: newHandlingStatus < 0,
    isSpinout: newHandlingStatus < -5,
    skidDirectionDegrees,
    finalFacing,
    nextSpeed,
    pendingControlRoll: null,
    crashOutcome: null
  });
}

// ------------------------------------------------------------
// Exports (explicit for API generator compatibility)
// ------------------------------------------------------------
export { performManeuver as executeManeuver };

------------------------------------------------------------
FILE: \module\movement\phase-tracker.js
------------------------------------------------------------

  >>> PATTERN: export 
     export class PhaseTracker {

  >>> PATTERN: class 
     export class PhaseTracker {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/phase-tracker.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Movement Phase Tracker (Phase 2)
// Adds checks for:
// - pending control rolls
// - crash outcomes
// - conforming movement
// - spinout recovery
// ------------------------------------------------------------

export class PhaseTracker {
  constructor() {
    this.currentPhase = 1;
    this.maxPhases = 10;
  }

  nextPhase() {
    this.currentPhase = Math.min(this.currentPhase + 1, this.maxPhases);
    console.log(`🚗 [carwars] Movement Phase advanced to ${this.currentPhase}`);
  }
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    if (mv.crashOutcome) return false;

    // RAW: conforming vehicles do not act independently
    if (mv.isConforming) return false;

    // RAW: spinout recovery skips this phase
    if (mv.wasSpinoutLastPhase) return false;

    return true;
  }

  debugPhase(vehicles) {
    console.log(`📘 [carwars] Phase ${this.currentPhase} acting vehicles:`);

    for (const v of vehicles) {
      const acts = this.shouldVehicleAct(v);
      console.log(` - ${v.name}: ${acts ? "ACTS" : "waits"}`);
    }
  }
}

------------------------------------------------------------
FILE: \module\movement\roll-physics.js
------------------------------------------------------------

  >>> PATTERN: export 
     export async function resolveRoll(actor, severity) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/roll-physics.js
// ------------------------------------------------------------
// Car Wars Deluxe — Roll Physics Engine (Phase 2)
// Pure logic only — no actor updates, no token movement,
// no chat messages, no dice rolls.
// ------------------------------------------------------------

/**
 * Resolve a "rolling" crash result from Crash Table 1.
 *
 * Phase 2 rules:
 * - No dice are rolled here.
 * - No actor or token updates occur here.
 * - No chat messages are created here.
 * - This module returns a structured outcome object.
 *
 * @param {Actor} actor    The vehicle actor
 * @param {number} severity Crash Table 1 severity (5–9)
 * @returns {object}       Structured roll outcome
 */
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  // Phase 2: return the *need* for a burning check, not the result.
  // ------------------------------------------------------------
  const requiresBurnCheck = severity >= 6;

  // ------------------------------------------------------------
  // Return structured outcome (Phase 2 standard)
  // ------------------------------------------------------------
  return {
    type: "roll",
    severity,
    steps,
    dmgFormula,
    appliedFacings,     // array of facings hit in order
    speedBefore: speed,
    speedAfter,
    deltaRotation,      // degrees to rotate token (Phase 4)
    requiresBurnCheck,  // Phase 4 UI will prompt the player
    damageLog: []       // Phase 4 will fill this after dice rolls
  };
}

------------------------------------------------------------
FILE: \module\movement\skid-physics.js
------------------------------------------------------------

  >>> PATTERN: export 
     export async function resolveSkid(actor, severity) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/skid-physics.js
// ------------------------------------------------------------
// Car Wars Deluxe — Skid Physics Engine (Phase 2)
// Pure logic only — no actor updates, no token movement,
// no chat messages, no drawings, no templates.
// ------------------------------------------------------------

/**
 * Resolve a skid result from Crash Table 1.
 * severity = 1, 2, 3, or 4
 *
 * Returns a structured outcome object consumed by crash-router.js
 * and later by Phase 4 UI modules.
 */
export async function resolveSkid(actor, severity) {
  // ------------------------------------------------------------
  // RAW Skid Distances (in inches)
  // ------------------------------------------------------------
  let distanceInches = 0;

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

/**
 * Determine the direction the vehicle was moving BEFORE losing control.
 * Uses token rotation.
 */
function getPreLossDirection(actor) {
  const token = actor.getActiveTokens()[0];
  return token ? token.rotation : 0;
}

/**
 * Convert direction + distance into offset (in inches).
 */
function computeSkidOffset(direction, distanceInches) {
  const radians = (direction * Math.PI) / 180;
  return {
    dx: Math.cos(radians) * distanceInches,
    dy: Math.sin(radians) * distanceInches
  };
}

------------------------------------------------------------
FILE: \module\movement\skid-template.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { inchesToPixels } from "./movement-engine.js";

  >>> PATTERN: export 
     export class SkidTemplate {

  >>> PATTERN: class 
     export class SkidTemplate {

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: canvas\.
     const startX = actor.token.x + canvas.grid.size / 2;
     const startY = actor.token.y + canvas.grid.size / 2;
     return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
     const templates = canvas.templates.placeables.filter(t =>
     return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/skid-template.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Skid Templates
// Visualizes uncontrolled drift during skids and fishtails.
// ------------------------------------------------------------

import { inchesToPixels } from "./movement-engine.js";

export class SkidTemplate {
  /**
   * Create a skid template.
   * @param {Actor} actor
   * @param {Object} skidData - { distanceInches, directionDegrees }
   */
  static createFor(actor, skidData) {
    if (!actor.token) return;

    const startX = actor.token.x + canvas.grid.size / 2;
    const startY = actor.token.y + canvas.grid.size / 2;

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        }
      }
    };

    return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
  }

  /**
   * Remove all skid templates for this actor.
   */
  static removeFor(actor) {
    const templates = canvas.templates.placeables.filter(t =>
      t.document.getFlag("cw", "skid") &&
      t.document.getFlag("cw", "actorId") === actor.id
    );

    const ids = templates.map(t => t.id);
    return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);
  }
}

------------------------------------------------------------
FILE: \module\movement\spinout-template.js
------------------------------------------------------------

  >>> PATTERN: export 
     export class SpinoutTemplate {

  >>> PATTERN: class 
     export class SpinoutTemplate {

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: canvas\.
     const x = actor.token.x + canvas.grid.size / 2;
     const y = actor.token.y + canvas.grid.size / 2;
     return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
     const templates = canvas.templates.placeables.filter(t =>
     return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/spinout-template.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Spinout Template
// Shows a simple circular marker where the vehicle spun out.
// ------------------------------------------------------------

export class SpinoutTemplate {
  static createFor(actor) {
    if (!actor.token) return;

    const x = actor.token.x + canvas.grid.size / 2;
    const y = actor.token.y + canvas.grid.size / 2;

    const templateData = {
      t: "circle",
      user: game.user.id,
      x,
      y,
      distance: 1, // 1" radius marker
      flags: {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
          spinout: true,
          actorId: actor.id
        }
      }
    };

    return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
  }

  static removeFor(actor) {
    const templates = canvas.templates.placeables.filter(t =>
      t.document.getFlag("cw", "spinout") &&
      t.document.getFlag("cw", "actorId") === actor.id
    );

    if (!templates.length) return;
    const ids = templates.map(t => t.id);
    return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);
  }
}

------------------------------------------------------------
FILE: \module\movement\spinout.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function resolveSpinout(actor, severity = 1) {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/spinout.js
// ------------------------------------------------------------
// Car Wars Deluxe — Spinout Physics (Phase 2)
// Pure logic only — no dice rolls, no token updates,
// no templates, no chat messages.
// ------------------------------------------------------------

/**
 * Resolve a spinout result.
 *
 * RAW Summary:
 * - Vehicle rotates randomly: 1d6 × 60°
 * - Vehicle ends facing the rolled direction
 * - Vehicle usually drops to 0 speed
 * - Vehicle is considered out of control for the remainder of the phase
 *
 * Phase 2 rules:
 * - Do NOT roll dice here.
 * - Do NOT rotate tokens.
 * - Do NOT create templates.
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  const temporarySpeed = 0;

  return {
    type: "spinout",
    severity,

    // Phase 2: return formula, not rolled value
    rotationFormula,

    // UI will compute final facing after rolling
    finalFacing: null,

    // RAW: speed drops to 0
    temporarySpeed,

    // Flags for movement-state
    isSpinout: true,
    isSkidding: false
  };
}

------------------------------------------------------------
FILE: \module\movement\templates.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { MANEUVERS } from "./maneuver-registry.js";
     import { inchesToPixels } from "./movement-engine.js";
     import { getControlModifier } from "./control-table.js";
     import { TurningKeyTemplate } from "./turningkey-template.js";

  >>> PATTERN: export 
     export class TemplateRenderer {

  >>> PATTERN: class 
     export class TemplateRenderer {
     const hc = token.actor.system.handlingClass || 0;

  >>> PATTERN: canvas\.
     canvas.stage.addChild(preview);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/templates.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Turning Key Template Renderer
// RAW-accurate Turning Key Arc Geometry
// ------------------------------------------------------------

import { MANEUVERS } from "./maneuver-registry.js";
import { inchesToPixels } from "./movement-engine.js";
import { getControlModifier } from "./control-table.js";
import { TurningKeyTemplate } from "./turningkey-template.js";

export class TemplateRenderer {

  static activePreview = null;

  static previewManeuver(token, maneuverId, direction = "left") {
    if (!token) {
      console.warn("[TurningKey] No token selected.");
      return;
    }
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        return 0;
    }
  }

  // ------------------------------------------------------------
  // Legality coloring
  // ------------------------------------------------------------
  static _getLegalityColor(token, maneuver) {
    const speed = token.actor.system.speed || 0;
    const hc = token.actor.system.handlingClass || 0;

    const modifier = getControlModifier(speed, hc);

    if (modifier === "safe") return 0x00ff00;
    if (modifier === "XX") return 0xff0000;
    return 0xffff00;
  }
}

window.TemplateRenderer = TemplateRenderer;

------------------------------------------------------------
FILE: \module\movement\temporary-speed.js
------------------------------------------------------------

  >>> PATTERN: export 
     export const TST = [
     export function getTemporarySpeed(myDM, theirDM, originalSpeed) {

  >>> PATTERN: ui\.
     // Pure logic only. No actor updates, no chat, no UI.

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/temporary-speed.js
// ------------------------------------------------------------
// Car Wars Deluxe — Temporary Speed Table (TST) (Phase 2)
// Pure logic only. No actor updates, no chat, no UI.
// ------------------------------------------------------------

const FRACTIONS = {
  "1": 1,
  "¾": 0.75,
  "½": 0.5,
  "¼": 0.25,
  "0": 0
};

// RAW TST table
export const TST = [
  ["½","¾","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
  ["1","1","¾","¾","½","¼","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
function parseFraction(str) {
  return FRACTIONS[str] ?? 1;
}

function roundUpTo5(x) {
  return Math.ceil(x / 5) * 5;
}

/**
 * Pure logic: compute temporary speed after collision.
 */
export function getTemporarySpeed(myDM, theirDM, originalSpeed) {
  const myIndex = Math.max(0, Math.min(20, Math.floor(myDM)));
  const theirIndex = Math.max(0, Math.min(20, Math.floor(theirDM)));

  const fractionStr = TST[myIndex][theirIndex];
  const multiplier = parseFraction(fractionStr);

  return roundUpTo5(originalSpeed * multiplier);
}

------------------------------------------------------------
FILE: \module\movement\turn-arc-template.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { inchesToPixels } from "./movement-engine.js";

  >>> PATTERN: export 
     export class TurnArcTemplate {

  >>> PATTERN: class 
     export class TurnArcTemplate {

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: canvas\.
     const startX = actor.token.x + canvas.grid.size / 2;
     const startY = actor.token.y + canvas.grid.size / 2;
     return canvas.scene.createEmbeddedDocuments("MeasuredTemplate", [templateData]);
     const templates = canvas.templates.placeables.filter(t =>
     return canvas.scene.deleteEmbeddedDocuments("MeasuredTemplate", ids);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/turn-arc-template.js
// ------------------------------------------------------------
// Car Wars Deluxe Edition — Turn Arc Templates
// Draws curved maneuver paths (bends, turns, bootleggers).
// ------------------------------------------------------------

import { inchesToPixels } from "./movement-engine.js";

export class TurnArcTemplate {
  /**
   * Create a turn arc template for a maneuver.
   * @param {Actor} actor
   * @param {Object} maneuver - from ManeuverRegistry
   */
  static createFor(actor, maneuver) {
    if (!actor.token) return;

    const startX = actor.token.x + canvas.grid.size / 2;
    const startY = actor.token.y + canvas.grid.size / 2;
    const facing = actor.token.rotation || 0;
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      "bootlegger": { radius: 5, angle: 180 }
    };

    return table[maneuver.id] || { radius: 5, angle: 45 };
  }

  /**
   * Compute the center point of the turn arc.
   * This is perpendicular to the vehicle's facing.
   */
  static computeTurnCenter(x, y, facing, radiusPx, direction) {
    const angleRad =
      (facing + (direction === "left" ? -90 : 90)) * (Math.PI / 180);

    return {
      x: x + Math.cos(angleRad) * radiusPx,
      y: y + Math.sin(angleRad) * radiusPx
    };
  }
}

------------------------------------------------------------
FILE: \module\movement\turningkey-measuredtemplate.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { TemplateRenderer } from "./templates.js";
     import { MANEUVERS } from "./maneuver-registry.js";
     import { inchesToPixels } from "./movement-engine.js";

  >>> PATTERN: export 
     export class TurningKeyMeasuredTemplate extends foundry.canvas.placeables.MeasuredTemplate {

  >>> PATTERN: class 
     // Custom MeasuredTemplate class for Turning Key arcs
     export class TurningKeyMeasuredTemplate extends foundry.canvas.placeables.MeasuredTemplate {
     // Register custom template type + class (Foundry V13+)
     // Register the custom class for this template type

  >>> PATTERN: Hooks\.(once|on)\(
     Hooks.once("init", () => {

  >>> PATTERN: CONFIG\.
     CONFIG.MeasuredTemplate.objectClass.turningKey = TurningKeyMeasuredTemplate;

  >>> PATTERN: canvas\.
     export class TurningKeyMeasuredTemplate extends foundry.canvas.placeables.MeasuredTemplate {
     const token = canvas.tokens.get(tokenId);

  >>> PATTERN: foundry\.
     export class TurningKeyMeasuredTemplate extends foundry.canvas.placeables.MeasuredTemplate {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/turningkey-measuredtemplate.js
// ------------------------------------------------------------
// Custom MeasuredTemplate class for Turning Key arcs
// ------------------------------------------------------------

import { TemplateRenderer } from "./templates.js";
import { MANEUVERS } from "./maneuver-registry.js";
import { inchesToPixels } from "./movement-engine.js";

// Use the v13+ namespaced MeasuredTemplate
export class TurningKeyMeasuredTemplate extends foundry.canvas.placeables.MeasuredTemplate {

  // ------------------------------------------------------------
  // Override draw() to render a curved Turning Key arc
  // ------------------------------------------------------------
  async draw() {
    await super.draw();

    const maneuverId = this.document.getFlag("carwars-system", "maneuverId");
    const direction = this.document.getFlag("carwars-system", "direction");
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    return this;
  }

  // ------------------------------------------------------------
  // IMPORTANT: Do NOT override refresh()
  // Foundry handles refresh → draw lifecycle correctly.
  // ------------------------------------------------------------
}


// ------------------------------------------------------------
// Register custom template type + class (Foundry V13+)
// ------------------------------------------------------------
Hooks.once("init", () => {

  // Register the custom class for this template type
  CONFIG.MeasuredTemplate.objectClass.turningKey = TurningKeyMeasuredTemplate;

  console.log("🔵 [TurningKey] Registered TurningKeyMeasuredTemplate (v13 compatible)");
});

------------------------------------------------------------
FILE: \module\movement\turningkey-template.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { MANEUVERS } from "./maneuver-registry.js";
     import { inchesToPixels } from "./movement-engine.js";
     import { TemplateRenderer } from "./templates.js";
     import { TurningKeyMeasuredTemplate } from "./turningkey-measuredtemplate.js";

  >>> PATTERN: export 
     export class TurningKeyTemplate {

  >>> PATTERN: class 
     export class TurningKeyTemplate {
     // Draw the preview (our class overrides draw())

  >>> PATTERN: game\.
     user: game.user.id,

  >>> PATTERN: ui\.
     ui.notifications.warn("Select a vehicle token first.");
     ui.notifications.error(`Unknown maneuver: ${maneuverId}`);

  >>> PATTERN: canvas\.
     const doc = new MeasuredTemplateDocument(templateData, { parent: canvas.scene });
     canvas.templates.addChild(preview);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/turningkey-template.js
// ------------------------------------------------------------
// Interactive Turning Key Template Placement (Portable-safe)
// ------------------------------------------------------------

import { MANEUVERS } from "./maneuver-registry.js";
import { inchesToPixels } from "./movement-engine.js";
import { TemplateRenderer } from "./templates.js";
import { TurningKeyMeasuredTemplate } from "./turningkey-measuredtemplate.js";

export class TurningKeyTemplate {

  /**
   * Begin interactive placement of a Turning Key template.
   * Portable-safe: uses a universal preview method compatible with v10–v13.
   */
  static async placeInteractive(token, maneuverId, direction = "left") {
    if (!token) {
      ui.notifications.warn("Select a vehicle token first.");
      return;
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    canvas.templates.addChild(preview);

    // Draw the preview (our class overrides draw())
    await preview.draw();

    // Enable drag-to-place interaction (universal method)
    if (typeof preview.activatePreviewListeners === "function") {
      preview.activatePreviewListeners();
    } else if (typeof preview.activateListeners === "function") {
      // Fallback for environments exposing a different API name
      preview.activateListeners();
    } else {
      // As a last resort, log a warning so developers can inspect
      console.warn("[TurningKey] Preview listeners could not be activated; interactive placement may not work in this environment.");
    }
  }
}

// Make available in console for debugging
globalThis.TurningKeyTemplate = TurningKeyTemplate;

------------------------------------------------------------
FILE: \module\movement\vault-physics.js
------------------------------------------------------------

  >>> PATTERN: export 
     export async function resolveVault(actor, severity, maneuverType = "") {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/movement/vault-physics.js
// ------------------------------------------------------------
// Car Wars Deluxe — Vault Physics Engine (Phase 2)
// Pure logic only — no actor updates, no token movement,
// no chat messages, no dice rolls.
// ------------------------------------------------------------

/**
 * Resolve a vault result (Crash Table 1: 10+)
 *
 * RAW Summary:
 * - Tires doing the vaulting take 3d6 damage
 * - Vehicle flies 1d6" in pre-crash direction
 * - Rotates two facings per inch traveled
 * - Landing side takes collision damage at initial speed
 * - Tight bend / hard swerve → flip end-over-end
 * - All occupants take 1 damage (ignores armor)
 * - After landing, vehicle continues rolling as per 6–9
 *
 * Phase 2 rules:
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

    // Airborne rotation
    rotationFormula,
    facingsPerInch,
    degreesPerFacing,

    // Flip logic
    flipEndOverEnd,

    // Landing collision
    landingFacing,
    landingDamageFormula,

    // Occupant damage
    occupantDamage,

    // Follow-up roll
    followUpRollSeverity
  };
}

------------------------------------------------------------
FILE: \module\rolls\control-rolls.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { routeCrash } from "../movement/crash-router.js";
     import { updateMovementState } from "../movement/movement-state.js";

  >>> PATTERN: export 
     // Additional export required by importers
     export { routeCrash };

  >>> PATTERN: Hooks\.(once|on)\(
     Hooks.on("renderChatMessage", (message, html) => {

  >>> PATTERN: game\.
     const actor = game.actors.get(actorId);

  >>> PATTERN: ui\.
     ui.notifications.warn("No pending control roll found.");

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/rolls/control-rolls.js
// ------------------------------------------------------------
// Player-facing control roll handler (Phase 2)
// - Reads pending control roll from actor
// - Rolls 2d6
// - Compares to target
// - Routes crash if failed
// - Updates movement state
// ------------------------------------------------------------

import { routeCrash } from "../movement/crash-router.js";
import { updateMovementState } from "../movement/movement-state.js";

Hooks.on("renderChatMessage", (message, html) => {
  const button = html[0]?.querySelector(".control-roll-button");
  if (!button) return;

  button.addEventListener("click", async () => {
    const actorId = button.dataset.actorId;
    const actor = game.actors.get(actorId);
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    const crashOutcome = await routeCrash(actor, {
      success: false,
      target,
      roll: total,
      margin: target - total,
      crashTable
    });

    // ------------------------------------------------------------
    // Update movement state with crash outcome
    // ------------------------------------------------------------
    await updateMovementState(actor, {
      pendingControlRoll: null,
      crashOutcome
    });
  });
});

// Additional export required by importers
export { routeCrash };

------------------------------------------------------------
FILE: \module\rolls\hazard.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\rules\apply\apply-accessories.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyAccessories(actor, rules) {

  >>> PATTERN: game\.
     const accData = game.cw.catalog.accessories.find(a => a.id === accId);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/rules/apply/apply-accessories.js

export function applyAccessories(actor, rules) {
  const accessories = actor.items.filter(i => i.type === "accessory");

  for (const acc of accessories) {
    const accId = acc.system.key;
    const accData = game.cw.catalog.accessories.find(a => a.id === accId);
    if (!accData) continue;

    rules.weight += accData.weight || 0;
    rules.spaces += accData.spaces || 0;

    // Special rules
    for (const rule of accData.specialRules || []) {
      applyAccessoryRule(rule, rules);
    }
  }
}

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    case "hazardMod":
      rules.hazard += Number(value);
      break;

    case "weaponSpaceBonus":
      rules.spaces += Number(value);
      break;

    default:
      console.warn("Unknown accessory rule:", rule);
  }
}

function parseRule(rule) {
  if (rule.includes(":")) {
    const [key, value] = rule.split(":");
    return [key, value];
  }
  return [rule, true];
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-armor.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyArmor(actor, rules) {

  >>> FILE SNIPPET:
// module/rules/apply/apply-armor.js

export function applyArmor(actor, rules) {
  const armor = actor.system.armor;
  if (!armor) return;

  const totalPoints =
    armor.front +
    armor.back +
    armor.left +
    armor.right +
    armor.top +
    armor.under;

  rules.armorPoints = totalPoints;

  // Weight & cost per point come from body
  if (rules.armorWeightPerPoint) {
    rules.weight += totalPoints * rules.armorWeightPerPoint;
  }
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-body.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyBody(actor, rules) {

  >>> PATTERN: game\.
     const bodyData = game.cw.catalog.bodies.find(b => b.id === bodyId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-body.js

export function applyBody(actor, rules) {
  const bodyId = actor.system.bodyType;
  if (!bodyId) return;

  const bodyData = game.cw.catalog.bodies.find(b => b.id === bodyId);
  if (!bodyData) return;

  // Weight & spaces
  rules.weight += bodyData.weight;
  rules.totalSpaces = bodyData.spaces;

  // Max weight (special: body defines this)
  rules.maxWeight = bodyData.maxWeight;

  // Cargo
  rules.cargoSpaces = bodyData.cargoSpaces || 0;

  // Armor cost/weight per point (used later)
  rules.armorCostPerPoint = bodyData.armorCostPerPoint;
  rules.armorWeightPerPoint = bodyData.armorWeightPerPoint;

  // Special rules (if any)
  if (bodyData.specialRules) {
    for (const rule of bodyData.specialRules) {
      // Placeholder for future body-specific rules
    }
  }
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-chassis.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyChassis(actor, rules) {

  >>> PATTERN: game\.
     const chassisData = game.cw.catalog.chassis.find(c => c.id === chassisId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-chassis.js

export function applyChassis(actor, rules) {
  const chassisId = actor.system.chassisType;
  if (!chassisId) return;

  const chassisData = game.cw.catalog.chassis.find(c => c.id === chassisId);
  if (!chassisData) return;

  // Chassis affects max weight
  rules.maxWeight = chassisData.maxWeight;

  // Chassis cost is handled in construction, not here
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-engine.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyEngine(actor, rules) {

  >>> PATTERN: game\.
     const engineData = game.cw.catalog.powerplants.find(e => e.id === engineId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-engine.js

export function applyEngine(actor, rules) {
  const engineId = actor.system.powerPlantType;
  if (!engineId) return;

  const engineData = game.cw.catalog.powerplants.find(e => e.id === engineId);
  if (!engineData) return;

  rules.weight += engineData.weight;
  rules.spaces += engineData.spaces;

  rules.pf = engineData.pf;
  rules.mpg = engineData.baseMPG;
  rules.dp = engineData.dp;

  // Engine cost handled elsewhere
}
/* Auto-generated placeholder for apply-engine.js */

------------------------------------------------------------
FILE: \module\rules\apply\apply-gas-tank.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyGasTank(actor, rules) {

  >>> PATTERN: game\.
     const tankData = game.cw.catalog.gasTanks.find(t => t.id === tankId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-gas-tank.js

export function applyGasTank(actor, rules) {
  const tankId = actor.system.gasTankType;
  if (!tankId) return;

  const tankData = game.cw.catalog.gasTanks.find(t => t.id === tankId);
  if (!tankData) return;

  const gallons = actor.system.gasGallons || 0;

  rules.weight += gallons * tankData.weightPerGallon;
  rules.spaces += tankData.space || 0;

  rules.dp += tankData.dp;
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-suspension.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applySuspension(actor, rules) {

  >>> PATTERN: game\.
     const suspData = game.cw.catalog.suspension.find(s => s.id === suspensionId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-suspension.js

export function applySuspension(actor, rules) {
  const suspensionId = actor.system.suspensionType;
  if (!suspensionId) return;

  const suspData = game.cw.catalog.suspension.find(s => s.id === suspensionId);
  if (!suspData) return;

  // HC modifiers
  rules.handling += suspData.hc || 0;

  // Special cases for vans/subcompacts
  const bodyId = actor.system.bodyType;
  if (bodyId === "van" && suspData.vanHC) rules.handling += suspData.vanHC;
  if (bodyId === "subcompact" && suspData.subHC) rules.handling += suspData.subHC;
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-tires.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyTires(actor, rules) {

  >>> PATTERN: game\.
     const tireData = game.cw.catalog.tires.find(t => t.id === tireId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-tires.js

export function applyTires(actor, rules) {
  const tireId = actor.system.tireType;
  if (!tireId) return;

  const tireData = game.cw.catalog.tires.find(t => t.id === tireId);
  if (!tireData) return;

  const quantity = actor.system.tireCount || 4;

  rules.weight += tireData.weight * quantity;

  // Tire DP is tracked per tire, not added to vehicle DP
}

------------------------------------------------------------
FILE: \module\rules\apply\apply-weapons.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function applyWeapons(actor, rules) {

  >>> PATTERN: game\.
     const weaponData = game.cw.catalog.weapons.find(we => we.id === weaponId);

  >>> FILE SNIPPET:
// module/rules/apply/apply-weapons.js

export function applyWeapons(actor, rules) {
  const weapons = actor.items.filter(i => i.type === "weapon");

  for (const w of weapons) {
    const weaponId = w.system.key;
    const weaponData = game.cw.catalog.weapons.find(we => we.id === weaponId);
    if (!weaponData) continue;

    rules.weight += weaponData.weight;
    rules.spaces += weaponData.spaces;

    // Ammo weight
    const ammo = w.system.ammo || 0;
    rules.weight += ammo * weaponData.ammoWeight;
  }
}

------------------------------------------------------------
FILE: \module\rules\loaders\accessories-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for accessories-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\armor-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for armor-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\body-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for body-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\chassis-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for chassis-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\engine-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for engine-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\gas-tank-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for gas-tank-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\suspension-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for suspension-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\tires-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for tires-loader.js */

------------------------------------------------------------
FILE: \module\rules\loaders\weapons-loader.js
------------------------------------------------------------

  >>> FILE SNIPPET:
/* Auto-generated placeholder for weapons-loader.js */

------------------------------------------------------------
FILE: \module\rules\rule-engine.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { applyBody } from "./apply/apply-body.js";
     import { applyChassis } from "./apply/apply-chassis.js";
     import { applySuspension } from "./apply/apply-suspension.js";
     import { applyEngine } from "./apply/apply-engine.js";
     import { applyGasTank } from "./apply/apply-gas-tank.js";
     import { applyTires } from "./apply/apply-tires.js";
     import { applyArmor } from "./apply/apply-armor.js";
     import { applyWeapons } from "./apply/apply-weapons.js";
     import { applyAccessories } from "./apply/apply-accessories.js";

  >>> PATTERN: export 
     export class RuleEngine {

  >>> PATTERN: class 
     export class RuleEngine {

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/rules/rule-engine.js

import { applyBody } from "./apply/apply-body.js";
import { applyChassis } from "./apply/apply-chassis.js";
import { applySuspension } from "./apply/apply-suspension.js";
import { applyEngine } from "./apply/apply-engine.js";
import { applyGasTank } from "./apply/apply-gas-tank.js";
import { applyTires } from "./apply/apply-tires.js";
import { applyArmor } from "./apply/apply-armor.js";
import { applyWeapons } from "./apply/apply-weapons.js";
import { applyAccessories } from "./apply/apply-accessories.js";

export class RuleEngine {
  constructor(actor) {
    this.actor = actor;

    this.rules = {
      weight: 0,
      spaces: 0,
      totalSpaces: 0,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  _apply(label, fn) {
    const before = structuredClone(this.rules);
    fn(this.actor, this.rules);
    const after = this.rules;

    this.log(label, {
      weight: after.weight - before.weight,
      spaces: after.spaces - before.spaces,
      handling: after.handling - before.handling,
      hazard: after.hazard - before.hazard,
      pf: after.pf - before.pf,
      mpg: after.mpg - before.mpg,
      accel: after.accel - before.accel,
      topSpeed: after.topSpeed - before.topSpeed,
      dp: after.dp - before.dp,
      maxWeight: after.maxWeight !== before.maxWeight ? after.maxWeight : undefined,
      armorPoints: after.armorPoints - before.armorPoints
    });
  }
}

------------------------------------------------------------
FILE: \module\ui\chat\control-roll-card.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function renderControlRollCard(control) {

  >>> FILE SNIPPET:
// module/ui/chat/control-roll-card.js
// Renders a control roll prompt card into chat.

export function renderControlRollCard(control) {
  if (!control || !control.required) return;

  const html = `
    <div class="carwars-control-roll-card">
      <h3>Control Roll Required</h3>
      <p><strong>Target:</strong> ${control.target}</p>
      <p><strong>Reason:</strong> ${control.reason}</p>
      <button class="carwars-control-roll-btn" data-target="${control.target}">
        Roll Control
      </button>
    </div>
  `;

  ChatMessage.create({
    content: html,
    speaker: { alias: "Movement Phase" }
  });
}

------------------------------------------------------------
FILE: \module\ui\chat\crash-card.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function renderCrashCard(crash) {

  >>> FILE SNIPPET:
// module/ui/chat/crash-card.js
// Renders a crash result card into chat.

export function renderCrashCard(crash) {
  if (!crash) return;

  const html = `
    <div class="carwars-crash-card">
      <h3>Crash Result</h3>
      <p><strong>Type:</strong> ${crash.type}</p>
      <p><strong>Severity:</strong> ${crash.severity}</p>
      <p><strong>Notes:</strong> ${crash.notes || "—"}</p>
    </div>
  `;

  ChatMessage.create({
    content: html,
    speaker: { alias: "Movement Phase" }
  });
}

------------------------------------------------------------
FILE: \module\ui\chat\hazard-card.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function renderHazardCard(hazards) {

  >>> FILE SNIPPET:
// module/ui/chat/hazard-card.js
// Renders a simple hazard summary card into chat.

export function renderHazardCard(hazards) {
  if (!hazards || hazards.length === 0) return;

  const list = hazards
    .map(h => `<li><strong>${h.type}</strong>: HC ${h.hcChange > 0 ? "+" : ""}${h.hcChange}</li>`)
    .join("");

  const html = `
    <div class="carwars-hazard-card">
      <h3>Hazards</h3>
      <ul>${list}</ul>
    </div>
  `;

  ChatMessage.create({
    content: html,
    speaker: { alias: "Movement Phase" }
  });
}

------------------------------------------------------------
FILE: \module\ui\movement\control-roll-result-handler.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runCrashTable } from "../../../movement/index.js";
     import { renderCrashCard } from "../chat/crash-card.js";
     import { updateMovementPanel } from "./movement-panel-updater.js";

  >>> PATTERN: export 
     export async function handleControlRollResult(actor, control, rollTotal) {

  >>> FILE SNIPPET:
// module/ui/movement/control-roll-result-handler.js
// Handles the dice result from a control roll and routes crash outcomes.

import { runCrashTable } from "../../../movement/index.js";
import { renderCrashCard } from "../chat/crash-card.js";
import { updateMovementPanel } from "./movement-panel-updater.js";

export async function handleControlRollResult(actor, control, rollTotal) {
  const success = rollTotal >= control.target;

  if (success) {
    // Successful control roll → apply the final movement state
    if (control.finalState) {
      updateMovementPanel(control.finalState);
    }

    return { success: true };
  }

  // Failed control roll → run crash table
  const crashResult = await runCrashTable(actor, control);

  // Render crash card
  renderCrashCard(crashResult);

  // Update movement panel with crash outcome
  if (crashResult.finalState) {
    updateMovementPanel(crashResult.finalState);
  }

  return {
    success: false,
    crash: crashResult
  };
}

------------------------------------------------------------
FILE: \module\ui\movement\maneuver-handler.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { executeMovementPhase } from "./movement-phase-service.js";

  >>> PATTERN: export 
     export async function onManeuverSelected(actor, maneuverId) {
     // Additional export required by importers
     export { onManeuverSelected as storeManeuver };

  >>> PATTERN: game\.
     const maneuver = game.carwars.maneuvers.get(maneuverId);

  >>> FILE SNIPPET:
// module/ui/movement/maneuver-handler.js
// Handles maneuver selection and triggers movement phase execution.

import { executeMovementPhase } from "./movement-phase-service.js";

export async function onManeuverSelected(actor, maneuverId) {
  const maneuver = game.carwars.maneuvers.get(maneuverId);
  const result = await executeMovementPhase(actor, maneuver);

  return result; // Phase 4 dispatcher will handle routing
}

// Additional export required by importers
export { onManeuverSelected as storeManeuver };

------------------------------------------------------------
FILE: \module\ui\movement\movement-panel-updater.js
------------------------------------------------------------

  >>> PATTERN: export 
     export function updateMovementPanel(finalState) {

  >>> PATTERN: game\.
     const actor = game.actors.get(finalState.actorId);

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/ui/movement/movement-panel-updater.js
// Applies final movement state to the actor sheet.

export function updateMovementPanel(finalState) {
  if (!finalState) return;

  const actor = game.actors.get(finalState.actorId);
  if (!actor) return;

  const updates = {};

  // Speed
  if (finalState.speed !== undefined) {
    updates["system.movement.currentSpeed"] = finalState.speed;
  }

  // Facing (Hybrid Facing Requirement)
  if (finalState.facing !== undefined) {
    updates["system.movement.facing"] = finalState.facing;

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  // Hazards
  if (finalState.hazards !== undefined) {
    updates["system.movement.hazards"] = finalState.hazards;
  }

  // Phase
  if (finalState.phase !== undefined) {
    updates["system.movement.phase"] = finalState.phase;
  }

  // Skid / Spinout flags
  if (finalState.isSkidding !== undefined) {
    updates["system.movement.isSkidding"] = finalState.isSkidding;
  }
  if (finalState.isSpinout !== undefined) {
    updates["system.movement.isSpinout"] = finalState.isSpinout;
  }

  actor.update(updates);
}

------------------------------------------------------------
FILE: \module\ui\movement\movement-phase-dispatcher.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { renderHazardCard } from "../chat/hazard-card.js";
     import { renderControlRollCard } from "../chat/control-roll-card.js";
     import { renderCrashCard } from "../chat/crash-card.js";
     import { updateMovementPanel } from "./movement-panel-updater.js";

  >>> PATTERN: export 
     export function handleMovementPhaseResult(result = {}) {

  >>> FILE SNIPPET:
// module/ui/movement/movement-phase-dispatcher.js
// Routes the movement phase result to the appropriate UI modules.

import { renderHazardCard } from "../chat/hazard-card.js";
import { renderControlRollCard } from "../chat/control-roll-card.js";
import { renderCrashCard } from "../chat/crash-card.js";
import { updateMovementPanel } from "./movement-panel-updater.js";

export function handleMovementPhaseResult(result = {}) {
  // Hazards
  if (Array.isArray(result.hazards) && result.hazards.length > 0) {
    renderHazardCard(result.hazards);
  }

  // Control Roll
  if (result.control && result.control.required === true) {
    renderControlRollCard(result.control);
  }

  // Crash
  if (result.crash) {
    renderCrashCard(result.crash);
  }

  // Final movement state (always update panel)
  const finalState = result.finalState ?? {};
  updateMovementPanel(finalState);
}

------------------------------------------------------------
FILE: \module\ui\movement\movement-phase-service.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import { runMovementPhaseForUI } from "../../movement/orchestrator/movement-phase-ui-adapter.js";
     import { handleMovementPhaseResult } from "./movement-phase-dispatcher.js";

  >>> PATTERN: export 
     export async function onManeuverSelected(actor, maneuverId) {
     export async function executeMovementPhase(actor) {
     // No adapter export — it does not exist

  >>> PATTERN: ui\.
     ui.notifications.warn("No actor selected for movement.");

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// module/ui/movement/movement-phase-service.js

// ------------------------------------------------------------
// IMPORTS
// ------------------------------------------------------------
import { runMovementPhaseForUI } from "../../movement/orchestrator/movement-phase-ui-adapter.js";
import { handleMovementPhaseResult } from "./movement-phase-dispatcher.js";


// ------------------------------------------------------------
// UI SERVICE — CALLED BY ACTOR SHEET
// ------------------------------------------------------------

/**
 * Called when the user selects a maneuver from the dropdown.
 * Stores the selected maneuver ID on the actor.
 */
export async function onManeuverSelected(actor, maneuverId) {
  if (!actor) return;

---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    speed: actor.system.movement?.lastSpeed ?? 0,
    handlingStatus: actor.system.movement?.handlingStatus ?? 0,
    lastManeuver: actor.system.movement?.lastManeuver ?? null
  };

  console.log("📦 [carwars] UI State:", uiState);

  // Run orchestrator
  const result = await runMovementPhaseForUI(actor, uiState);

  console.log("📤 [carwars] Movement Phase Result:", result);

  // Dispatch results to UI (hazards, control rolls, crash, panel updates)
  await handleMovementPhaseResult(actor, result);
}


// ------------------------------------------------------------
// No adapter export — it does not exist
// ------------------------------------------------------------

------------------------------------------------------------
FILE: \module\ui\helpers.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\ui\hud.js
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
FILE: \module\carwars.js
------------------------------------------------------------

  >>> PATTERN: ^import 
     import * as BaseActorModule from "./actor/base-actor.js";
     import * as VehicleDataModule from "./actor/vehicle-data.js";
     import * as DriverDataModule from "./actor/driver-data.js";
     import * as RegisterSheetsModule from "./actor/register-sheets.js";
     import * as ActorSheetModule from "./actor/actor-sheet.js";
     import * as PhaseTrackerModule from "./movement/phase-tracker.js";
     import "./movement/maneuver-registry.js";
     import "./movement/movement-engine.js";
     import "./movement/control-table.js";
     import "./movement/templates.js";
     import "./movement/turningkey-measuredtemplate.js";
     import * as TurningKeyModule from "./movement/turningkey-template.js";
     import * as MovementUIModule from "./ui/movement/movement-phase-service.js";

  >>> PATTERN: export 
     warn("PhaseTracker export is not a constructor; using stub:", PhaseTracker);

  >>> PATTERN: class 
     CONFIG.Actor.documentClass = CarWarsActor;
     log("Actor class registered:", CONFIG.Actor.documentClass?.name ?? "(unknown)");

  >>> PATTERN: Hooks\.(once|on)\(
     Hooks.once("init", async function () {
     Hooks.once("canvasReady", async () => {
     Hooks.once("setup", function () {
     Hooks.once("ready", function () {
     Hooks.on("combatRound", () => {
     Hooks.on("controlToken", (token, controlled) => {
     Hooks.on("renderSceneControls", (app, html, data) => {
     Hooks.on("renderTokenHUD", (hud, html) => {
     Hooks.on("renderCarWarsVehicleSheet", (sheet, html) => {

  >>> PATTERN: Handlebars\.registerHelper
     Handlebars.registerHelper("range", function(start, end, options) {

  >>> PATTERN: CONFIG\.
     CONFIG.CARWARS = {};
     CONFIG.CARWARS.bodies = await loadJSON("systems/carwars-system/data/bodies.json");
     CONFIG.CARWARS.bodies = {};
     CONFIG.Actor.documentClass = CarWarsActor;
     log("Actor class registered:", CONFIG.Actor.documentClass?.name ?? "(unknown)");
     CONFIG.Actor.dataModels = {
     log("DataModels registered:", Object.keys(CONFIG.Actor.dataModels));

  >>> PATTERN: game\.
     game.settings.register("carwars", "spinoutRollMode", {
     game.carwars = {
     log("Phase 5 UI API exposed:", game.carwars.ui);

  >>> PATTERN: ui\.
     if (!token) return ui.notifications.warn("Select a vehicle token first.");
     return ui.notifications.warn("This actor is not linked to a token.");

  >>> PATTERN: canvas\.
     const token = canvas.tokens.controlled[0] || lastSelectedToken;

  >>> PATTERN: foundry\.
     log("Templates preloaded via foundry.applications.handlebars.loadTemplates.");
     error("foundry.applications.handlebars.loadTemplates is not available.");

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
// ------------------------------------------------------------
// Static imports (namespace imports to allow robust fallback handling)
// ------------------------------------------------------------
import * as BaseActorModule from "./actor/base-actor.js";
import * as VehicleDataModule from "./actor/vehicle-data.js";
import * as DriverDataModule from "./actor/driver-data.js";
import * as RegisterSheetsModule from "./actor/register-sheets.js";
import * as ActorSheetModule from "./actor/actor-sheet.js";

import * as PhaseTrackerModule from "./movement/phase-tracker.js";
import "./movement/maneuver-registry.js";
import "./movement/movement-engine.js";
import "./movement/control-table.js";
import "./movement/templates.js";
import "./movement/turningkey-measuredtemplate.js";
import * as TurningKeyModule from "./movement/turningkey-template.js";

import * as MovementUIModule from "./ui/movement/movement-phase-service.js";

// ------------------------------------------------------------
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

  html.find(".tk-btn").on("click", ev => {
    const maneuver = ev.currentTarget.dataset.maneuver;
    const direction = ev.currentTarget.dataset.direction;

    log("Turning Key sheet button clicked:", { maneuver, direction });

    const token = sheet.token;
    if (!token) {
      warn("No token linked to actor.");
      return ui.notifications.warn("This actor is not linked to a token.");
    }

    try {
      TurningKeyTemplate.placeInteractive(token, maneuver, direction);
    } catch (e) {
      error("TurningKeyTemplate.placeInteractive failed:", e);
    }
  });
});

------------------------------------------------------------
FILE: \module\config.js
------------------------------------------------------------

  >>> PATTERN: CONFIG\.
     config.js

  >>> FILE SNIPPET:
config.js

============================================================
HANDLEBARS TEMPLATES (partials, includes, blocks)

------------------------------------------------------------
TEMPLATE: \module\actor\templates\driver-sheet.hbs
------------------------------------------------------------

  >>> PATTERN: data-tab
     <a class="item" data-tab="profile">Profile</a>
     <a class="item" data-tab="skills">Skills</a>
     <a class="item" data-tab="equipment">Equipment</a>
     <a class="item" data-tab="status">Status</a>
     <section class="tab profile" data-group="primary" data-tab="profile">
     <section class="tab skills" data-group="primary" data-tab="skills">
     <section class="tab equipment" data-group="primary" data-tab="equipment">
     <section class="tab status" data-group="primary" data-tab="status">

  >>> PATTERN: sheet-tabs
     <nav class="sheet-tabs tabs" data-group="primary">

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<form class="carwars driver-sheet" autocomplete="off">

  <!-- ========================= -->
  <!-- HEADER -->
  <!-- ========================= -->
  <header class="sheet-header">
    <h1>
      <input name="name" type="text" value="{{actor.name}}" placeholder="Driver Name"/>
    </h1>
  </header>

  <!-- ========================= -->
  <!-- TAB NAVIGATION -->
  <!-- ========================= -->
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="profile">Profile</a>
    <a class="item" data-tab="skills">Skills</a>
    <a class="item" data-tab="equipment">Equipment</a>
    <a class="item" data-tab="status">Status</a>
  </nav>
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    <section class="tab status" data-group="primary" data-tab="status">

      <h2>Status</h2>

      <div class="form-group">
        <label>Damage</label>
        <input type="number" name="system.damage" value="{{system.damage}}"/>
      </div>

      <div class="form-group">
        <label>Condition</label>
        <input type="text" name="system.condition" value="{{system.condition}}"/>
      </div>

      <button type="button" class="driver-action" data-action="focus">Driver Focus</button>

    </section>

  </section>
</form>

------------------------------------------------------------
TEMPLATE: \module\actor\templates\vehicle-sheet.hbs
------------------------------------------------------------

  >>> PATTERN: {{>\s*
     {{> "systems/carwars-system/templates/actor/partials/armor-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/weapon-summary.html"}}
     {{> "systems/carwars-system/templates/actor/partials/movement-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/hazard-display.html"}}
     {{> "systems/carwars-system/templates/actor/partials/hc-tracker.html"}}
     {{> "systems/carwars-system/templates/actor/partials/speed-control.html"}}
     {{> "systems/carwars-system/templates/actor/partials/armor-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/weapon-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/crew-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/systems-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/construction-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/validation-panel.html"}}

  >>> PATTERN: data-tab
     <a class="item" data-tab="overview">Overview</a>
     <a class="item" data-tab="movement">Movement</a>
     <a class="item" data-tab="armor">Armor</a>
     <a class="item" data-tab="weapons">Weapons</a>
     <a class="item" data-tab="crew">Crew</a>
     <a class="item" data-tab="systems">Systems</a>
     <a class="item" data-tab="construction">Construction</a>
     <a class="item" data-tab="validation">Validation</a>
     <section class="tab overview" data-group="primary" data-tab="overview">
     <section class="tab movement" data-group="primary" data-tab="movement">
     <section class="tab armor" data-group="primary" data-tab="armor">
     <section class="tab weapons" data-group="primary" data-tab="weapons">
     <section class="tab crew" data-group="primary" data-tab="crew">
     <section class="tab systems" data-group="primary" data-tab="systems">
     <section class="tab construction" data-group="primary" data-tab="construction">
     <section class="tab validation" data-group="primary" data-tab="validation">

  >>> PATTERN: sheet-tabs
     <nav class="sheet-tabs tabs" data-group="primary">

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<form class="carwars vehicle-sheet" autocomplete="off">

  <!-- ========================= -->
  <!-- HEADER -->
  <!-- ========================= -->
  <header class="sheet-header">
    <h1>
      <input name="name" type="text" value="{{actor.name}}" placeholder="Vehicle Name"/>
    </h1>
  </header>

  <!-- ========================= -->
  <!-- TAB NAVIGATION -->
  <!-- ========================= -->
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="overview">Overview</a>
    <a class="item" data-tab="movement">Movement</a>
    <a class="item" data-tab="armor">Armor</a>
    <a class="item" data-tab="weapons">Weapons</a>
    <a class="item" data-tab="crew">Crew</a>
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----

      <h2>Vehicle Construction</h2>

      {{> "systems/carwars-system/templates/actor/partials/construction-panel.html"}}

    </section>

    <!-- ====================================================== -->
    <!-- VALIDATION TAB -->
    <!-- ====================================================== -->
    <section class="tab validation" data-group="primary" data-tab="validation">

      <h2>Validation</h2>

      {{> "systems/carwars-system/templates/actor/partials/validation-panel.html"}}

    </section>

  </section>
</form>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\armor-panel.html
------------------------------------------------------------

  >>> FILE SNIPPET:
<div class="armor-panel grid-3col">
  <div class="armor-zone">
    <label>Front</label>
    <input type="number" name="system.armor.front" value="{{system.armor.front}}" />
  </div>
  <div class="armor-zone">
    <label>Left</label>
    <input type="number" name="system.armor.left" value="{{system.armor.left}}" />
  </div>
  <div class="armor-zone">
    <label>Right</label>
    <input type="number" name="system.armor.right" value="{{system.armor.right}}" />
  </div>
  <div class="armor-zone">
    <label>Back</label>
    <input type="number" name="system.armor.back" value="{{system.armor.back}}" />
  </div>
  <div class="armor-zone">
    <label>Top</label>
    <input type="number" name="system.armor.top" value="{{system.armor.top}}" />
  </div>
  <div class="armor-zone">
    <label>Underbody</label>
    <input type="number" name="system.armor.underbody" value="{{system.armor.underbody}}" />
  </div>
</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\construction-panel.html
------------------------------------------------------------

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
/* ========================================================= */
/* Systems Panel Styles                                       */
/* ========================================================= */

.carwars .systems-panel {
  padding: 0.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.carwars .system-section {
  border: 1px solid #333;
  border-radius: 3px;
  padding: 0.5rem;
}

.carwars .system-header {
  margin: 0 0 0.5rem 0;
  font-size: 1rem;
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  padding: 0.25rem 0;
  border-bottom: 1px solid #333;
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
}

.carwars .system-entry:last-child {
  border-bottom: none;
}

.carwars .system-sub {
  font-size: 0.75rem;
  opacity: 0.85;
}

.carwars .system-empty {
  opacity: 0.7;
  font-style: italic;
}

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\crew-panel.html
------------------------------------------------------------

  >>> PATTERN: {{#each
     {{#each system.crew.driver.skills}}{{this}}
     {{#each system.crew.driver.equipment}}{{this}}
     {{#each system.crew.gunner.skills}}{{this}}
     {{#each system.crew.gunner.equipment}}{{this}}
     {{#each system.crew.occupants}}

  >>> PATTERN: {{#if
     {{#if system.crew.occupants.length}}

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="crew-panel">

  <!-- ========================= -->
  <!-- DRIVER SECTION            -->
  <!-- ========================= -->
  <section class="crew-section crew-driver">
    <h3 class="crew-header">Driver</h3>

    <div class="crew-field">
      <label>Name</label>
      <input type="text"
             name="system.crew.driver.name"
             value="{{system.crew.driver.name}}"/>
    </div>

    <div class="crew-field">
      <label>Skills</label>
      <textarea name="system.crew.driver.skills">
{{#each system.crew.driver.skills}}{{this}}
{{/each}}
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  <!-- ========================= -->
  <!-- OCCUPANTS SECTION         -->
  <!-- ========================= -->
  <section class="crew-section crew-occupants">
    <h3 class="crew-header">Occupants</h3>

    {{#if system.crew.occupants.length}}
      <ul class="occupant-list">
        {{#each system.crew.occupants}}
          <li class="occupant-entry">
            {{this}}
          </li>
        {{/each}}
      </ul>
    {{else}}
      <p class="occupant-empty">No additional occupants.</p>
    {{/if}}
  </section>

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\engine-panel.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\hazard-display.html
------------------------------------------------------------

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="hazard-display">

  <!-- Total Hazards -->
  <div class="hazard-row hazard-total">
    <label>Total Hazards</label>
    <div class="hazard-controls">
      <button type="button"
              class="movement-control hazard-down"
              data-action="hazard-down">
        -
      </button>

      <span class="hazard-value">
        {{system.movement.hazards}}
      </span>

      <button type="button"
              class="movement-control hazard-up"
              data-action="hazard-up">
        +
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    </span>
  </div>

  <!-- Deceleration Hazard -->
  <div class="hazard-row hazard-decel">
    <label>Decel Hazard</label>
    <span class="hazard-value">
      {{system.movement.decelHazard}}
    </span>
  </div>

  <!-- Last Maneuver Difficulty -->
  <div class="hazard-row hazard-last-maneuver">
    <label>Last Maneuver D</label>
    <span class="hazard-value">
      {{system.movement.lastManeuverDifficulty}}
    </span>
  </div>

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\hc-tracker.html
------------------------------------------------------------

  >>> PATTERN: {{#each
     {{#each (range -6 7)}}

  >>> PATTERN: {{#if
     {{#if (eq this ../system.movement.handlingStatus)}}active{{/if}}">

  >>> FILE SNIPPET:
<div class="hc-tracker">

  <!-- Current HC -->
  <div class="hc-row hc-current">
    <label>Current HC</label>
    <span class="hc-value">
      {{system.movement.currentHC}}
    </span>
  </div>

  <!-- Handling Status Track (–6 to +6) -->
  <div class="hc-row hc-status">
    <label>Handling Status</label>
    <span class="hc-value">
      {{system.movement.handlingStatus}}
    </span>
  </div>

  <!-- Visual Track -->
  <div class="hc-track-bar">
    {{!-- Track positions from -6 to +6 --}}
    {{#each (range -6 7)}}
      <div class="hc-track-slot
                  {{#if (eq this ../system.movement.handlingStatus)}}active{{/if}}">
        {{this}}
      </div>
    {{/each}}
  </div>

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\movement-panel.html
------------------------------------------------------------

  >>> PATTERN: {{#if
     <div class="movement-flag movement-flag-skid {{#if system.movement.isSkidding}}active{{/if}}">
     {{#if system.movement.isSkidding}}Yes{{else}}No{{/if}}
     <div class="movement-flag movement-flag-spinout {{#if system.movement.isSpinout}}active{{/if}}">
     {{#if system.movement.isSpinout}}Yes{{else}}No{{/if}}
     <div class="movement-flag movement-flag-conforming {{#if system.movement.isConforming}}active{{/if}}">
     {{#if system.movement.isConforming}}Yes{{else}}No{{/if}}

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="movement-panel">

  <!-- ========================= -->
  <!-- Speed and Phase Control   -->
  <!-- ========================= -->
  <section class="movement-section movement-speed-phase">

    <div class="movement-speed-block">
      <div class="movement-field movement-speed-current">
        <label>Current Speed</label>
        <div class="movement-speed-controls">
          <button type="button"
                  class="movement-control speed-down"
                  data-action="speed-down">
            -
          </button>
          <span class="movement-value">
            {{system.movement.currentSpeed}}
          </span>
          <button type="button"
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
  <!-- ========================= -->
  <!-- Skid Data (Optional)      -->
  <!-- ========================= -->
  <section class="movement-section movement-skid-data">
    <div class="movement-field movement-skid-direction">
      <label>Skid Direction</label>
      <span class="movement-value">
        {{system.movement.skidData.direction}}
      </span>
    </div>

    <div class="movement-field movement-skid-distance">
      <label>Skid Distance</label>
      <span class="movement-value">
        {{system.movement.skidData.distance}}
      </span>
    </div>
  </section>

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\speed-control.html
------------------------------------------------------------

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="speed-control">

  <!-- Current Speed -->
  <div class="speed-row speed-current">
    <label>Current Speed</label>

    <div class="speed-buttons">
      <button type="button"
              class="movement-control speed-down"
              data-action="speed-down">
        -
      </button>

      <span class="speed-value">
        {{system.movement.currentSpeed}}
      </span>

      <button type="button"
              class="movement-control speed-up"
              data-action="speed-up">
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    </div>
  </div>

  <!-- Last Speed -->
  <div class="speed-row speed-last">
    <label>Last Speed</label>
    <span class="speed-value">
      {{system.movement.lastSpeed}}
    </span>
  </div>

  <!-- Temporary Speed (collision, RAW) -->
  <div class="speed-row speed-temp">
    <label>Temporary Speed</label>
    <span class="speed-value">
      {{system.movement.temporarySpeed}}
    </span>
  </div>

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\systems-panel.html
------------------------------------------------------------

  >>> PATTERN: {{#each
     {{#each system.components.tires.optionIds}}
     {{#each system.components.weapons}}
     {{#each system.components.accessories}}

  >>> PATTERN: {{#if
     {{#if system.components.powerplant.onFire}}Yes{{else}}No{{/if}}
     {{#if system.components.powerplant.destroyed}}Yes{{else}}No{{/if}}
     {{#if system.components.gasTank.onFire}}Yes{{else}}No{{/if}}
     {{#if system.components.gasTank.destroyed}}Yes{{else}}No{{/if}}
     {{#if system.components.weapons.length}}
     Destroyed: {{#if this.destroyed}}Yes{{else}}No{{/if}}
     {{#if system.components.accessories.length}}
     Destroyed: {{#if this.destroyed}}Yes{{else}}No{{/if}}

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="systems-panel">

  <!-- ========================= -->
  <!-- POWERPLANT                -->
  <!-- ========================= -->
  <section class="system-section system-powerplant">
    <h3 class="system-header">Powerplant</h3>

    <div class="system-field">
      <label>ID</label>
      <span class="system-value">{{system.components.powerplant.id}}</span>
    </div>

    <div class="system-field">
      <label>DP</label>
      <span class="system-value">{{system.components.powerplant.dp}}</span>
    </div>

    <div class="system-field">
      <label>On Fire</label>
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        {{#each system.components.accessories}}
          <li class="system-entry">
            <strong>{{this.id}}</strong>
            <span class="system-sub">DP: {{this.dp}}</span>
            <span class="system-sub">
              Destroyed: {{#if this.destroyed}}Yes{{else}}No{{/if}}
            </span>
            <span class="system-sub">Space Used: {{this.spaceUsed}}</span>
            <span class="system-sub">Space Granted: {{this.spaceGranted}}</span>
            <span class="system-sub">Weight Override: {{this.weightOverride}}</span>
            <span class="system-sub">Cost Override: {{this.costOverride}}</span>
          </li>
        {{/each}}
      </ul>
    {{else}}
      <p class="system-empty">No accessories installed.</p>
    {{/if}}
  </section>

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\validation-panel.html
------------------------------------------------------------

  >>> PATTERN: {{#each
     {{#each system.validation.errors}}
     {{#each system.validation.warnings}}

  >>> PATTERN: {{#if
     {{#if system.validation.errors.length}}
     {{#if system.validation.warnings.length}}

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="validation-panel">

  {{!-- ========================= --}}
  {{!-- ERRORS                    --}}
  {{!-- ========================= --}}
  {{#if system.validation.errors.length}}
  <div class="validation-section validation-errors">
    <h3>Errors ({{system.validation.errors.length}})</h3>
    <ul>
      {{#each system.validation.errors}}
      <li class="validation-entry error">{{this}}</li>
      {{/each}}
    </ul>
  </div>
  {{/if}}

  {{!-- ========================= --}}
  {{!-- WARNINGS                  --}}
  {{!-- ========================= --}}
  {{#if system.validation.warnings.length}}
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    <h3>Warnings ({{system.validation.warnings.length}})</h3>
    <ul>
      {{#each system.validation.warnings}}
      <li class="validation-entry warning">{{this}}</li>
      {{/each}}
    </ul>
  </div>
  {{/if}}

  {{!-- ========================= --}}
  {{!-- VALID BUILD MESSAGE       --}}
  {{!-- ========================= --}}
  {{#unless system.validation.errors.length}}
  <div class="validation-section validation-valid">
    <h3>Build Valid</h3>
    <p>No errors detected.</p>
  </div>
  {{/unless}}

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\weapon-panel.html
------------------------------------------------------------

  >>> PATTERN: {{#each
     {{#each system.weapons}}

  >>> PATTERN: {{#if
     {{#if system.weapons}}

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<div class="weapon-panel">

  {{#if system.weapons}}
    {{#each system.weapons}}
      <div class="weapon-entry">

        <!-- ========================= -->
        <!-- Weapon Header -->
        <!-- ========================= -->
        <div class="weapon-header">
          <strong class="weapon-name">{{this.name}}</strong>
          <span class="weapon-location">({{this.location}})</span>
        </div>

        <!-- ========================= -->
        <!-- Weapon Stats Row -->
        <!-- ========================= -->
        <div class="weapon-stats grid-4col">

          <div class="weapon-stat weapon-ammo">
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        <!-- ========================= -->
        {{!--
          Add these later if desired:
          <div class="weapon-extra">
            <div class="weapon-tohit">To-Hit: {{this.toHit}}</div>
            <div class="weapon-damage">Damage: {{this.damage}}</div>
            <div class="weapon-dp">DP: {{this.dp}}</div>
            <div class="weapon-effect">Effect: {{this.effect}}</div>
            <div class="weapon-special">Special: {{this.specialRules}}</div>
          </div>
        --}}
      </div>

      <hr class="weapon-divider"/>
    {{/each}}
  {{else}}
    <p class="weapon-none">No weapons mounted.</p>
  {{/if}}

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\partials\weapon-summary.html
------------------------------------------------------------

  >>> PATTERN: {{#each
     {{#each system.weapons}}

  >>> PATTERN: {{#if
     {{#if system.weapons}}

  >>> FILE SNIPPET:
<div class="weapon-summary">

  {{#if system.weapons}}
    {{#each system.weapons}}
      <div class="weapon-summary-row">
        <div class="weapon-name">
          <strong>{{this.name}}</strong>
        </div>

        <div class="weapon-location">
          <label>Location:</label> {{this.location}}
        </div>

        <div class="weapon-ammo">
          <label>Ammo:</label> {{this.ammo}}
        </div>

        <div class="weapon-arc">
          <label>Arc:</label> {{this.arc}}
        </div>

        <div class="weapon-group">
          <label>Group:</label> {{this.group}}
        </div>
      </div>
    {{/each}}
  {{else}}
    <p>No weapons mounted.</p>
  {{/if}}

</div>

------------------------------------------------------------
TEMPLATE: \templates\actor\driver-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:
<form class="carwars driver-sheet" autocomplete="off">
  <header class="sheet-header">
    <h1>
      <input name="name" type="text" value="{{actor.name}}" placeholder="Driver Name"/>
    </h1>
  </header>

  <section class="sheet-body">
    <div class="form-group">
      <label>Skill Level</label>
      <input type="number" name="system.skillLevel" value="{{system.skillLevel}}"/>
    </div>

    <div class="form-group">
      <label>Notes</label>
      <textarea name="system.notes">{{system.notes}}</textarea>
    </div>
  </section>
</form>

------------------------------------------------------------
TEMPLATE: \templates\actor\vehicle-sheet.html
------------------------------------------------------------

  >>> PATTERN: {{>\s*
     {{> "systems/carwars-system/templates/actor/partials/validation-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/movement-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/armor-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/crew-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/systems-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/construction-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/hazard-display.html"}}
     {{> "systems/carwars-system/templates/actor/partials/speed-control.html"}}
     {{> "systems/carwars-system/templates/actor/partials/hc-tracker.html"}}
     {{> "systems/carwars-system/templates/actor/partials/weapon-panel.html"}}
     {{> "systems/carwars-system/templates/actor/partials/weapon-summary.html"}}

  >>> PATTERN: data-tab
     <a class="item" data-tab="core">Core</a>
     <a class="item" data-tab="movement">Movement</a>
     <a class="item" data-tab="armor">Armor</a>
     <a class="item" data-tab="crew">Crew</a>
     <a class="item" data-tab="systems">Systems</a>
     <a class="item" data-tab="construction">Construction</a>
     <a class="item" data-tab="hazards">Hazards</a>
     <a class="item" data-tab="speed">Speed</a>
     <a class="item" data-tab="hc">HC</a>
     <a class="item" data-tab="weapons">Weapons</a>
     <a class="item" data-tab="summary">Summary</a>
     <div class="tab" data-group="primary" data-tab="core">
     <div class="tab" data-group="primary" data-tab="movement">
     <div class="tab" data-group="primary" data-tab="armor">
     <div class="tab" data-group="primary" data-tab="crew">
     <div class="tab" data-group="primary" data-tab="systems">
     <div class="tab" data-group="primary" data-tab="construction">
     <div class="tab" data-group="primary" data-tab="hazards">
     <div class="tab" data-group="primary" data-tab="speed">
     <div class="tab" data-group="primary" data-tab="hc">
     <div class="tab" data-group="primary" data-tab="weapons">
     <div class="tab" data-group="primary" data-tab="summary">

  >>> PATTERN: sheet-tabs
     <nav class="sheet-tabs tabs" data-group="primary">

  >>> PATTERN: tab"
     <div class="tab" data-group="primary" data-tab="core">
     <div class="tab" data-group="primary" data-tab="movement">
     <div class="tab" data-group="primary" data-tab="armor">
     <div class="tab" data-group="primary" data-tab="crew">
     <div class="tab" data-group="primary" data-tab="systems">
     <div class="tab" data-group="primary" data-tab="construction">
     <div class="tab" data-group="primary" data-tab="hazards">
     <div class="tab" data-group="primary" data-tab="speed">
     <div class="tab" data-group="primary" data-tab="hc">
     <div class="tab" data-group="primary" data-tab="weapons">
     <div class="tab" data-group="primary" data-tab="summary">

  >>> FILE SNIPPET:
---- BEGIN FIRST 20 LINES ----
<form class="carwars vehicle-sheet" autocomplete="off">

  <header class="sheet-header">
    <h1>
      <input name="name" type="text" value="{{actor.name}}" placeholder="Vehicle Name"/>
    </h1>
  </header>

  <!-- Validation Panel -->
  {{> "systems/carwars-system/templates/actor/partials/validation-panel.html"}}

  <!-- Tab Navigation -->
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="core">Core</a>
    <a class="item" data-tab="movement">Movement</a>
    <a class="item" data-tab="armor">Armor</a>
    <a class="item" data-tab="crew">Crew</a>
    <a class="item" data-tab="systems">Systems</a>
    <a class="item" data-tab="construction">Construction</a>
    <a class="item" data-tab="hazards">Hazards</a>
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
    </div>

    <!-- HC Tracker Tab -->
    <div class="tab" data-group="primary" data-tab="hc">
      {{> "systems/carwars-system/templates/actor/partials/hc-tracker.html"}}
    </div>

    <!-- Weapons Tab -->
    <div class="tab" data-group="primary" data-tab="weapons">
      {{> "systems/carwars-system/templates/actor/partials/weapon-panel.html"}}
    </div>

    <!-- Weapon Summary Tab -->
    <div class="tab" data-group="primary" data-tab="summary">
      {{> "systems/carwars-system/templates/actor/partials/weapon-summary.html"}}
    </div>

  </section>

</form>

------------------------------------------------------------
TEMPLATE: \templates\chat\control-roll-card.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\chat\maneuver-card.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\item\accessory-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\item\armor-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\item\powerplant-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\item\suspension-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\item\tire-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:

------------------------------------------------------------
TEMPLATE: \templates\item\weapon-sheet.html
------------------------------------------------------------

  >>> FILE SNIPPET:

============================================================
JSON DATA (first/last 20 lines)

------------------------------------------------------------
JSON: \data\accessories.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "accessories": [
    {
      "id": "active-suspension",
      "name": "Active Suspension",
      "category": "accessories",
      "cost": 4000,
      "spaces": 0,
      "weight": 100,
      "dp": 0,
      "specialRules": [
        "handlingBonus:1",
        "+1 to HC of vehicle"
      ],
      "notes": "+1 to HC of vehicle"
    },
    {
      "id": "anti-lock-brakes",
      "name": "Anti-lock Brakes",
      "category": "accessories",
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      "notes": "Uses 1 but gives 3 Weapon Spaces"
    },
    {
      "id": "component-weapon-pod-2",
      "name": "Component Weapon Pod - Two-space",
      "category": "accessories",
      "cost": 1000,
      "spaces": 2,
      "weight": 100,
      "dp": 0,
      "specialRules": [
        "weaponSpaceGranted:4",
        "Uses 2 but gives 4 Weapon Spaces"
      ],
      "notes": "Uses 2 but gives 4 Weapon Spaces"
    }
  ]
}
    
    

------------------------------------------------------------
JSON: \data\armor.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "armor": {
    "normal": {
      "id": "armor-normal",
      "name": "Normal Armor",
      "costPerPoint": 11,
      "weightPerPoint": 5,
      "specialRules": []
    },
    "fp": {
      "id": "armor-fp",
      "name": "Fireproof Armor",
      "costPerPoint": 22,
      "weightPerPoint": 5,
      "specialRules": [
        "Fireproof"
      ]
    },
    "lr": {
      "id": "armor-lr",
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      "id": "armor-metal",
      "name": "Metal Armor",
      "costPerPoint": 27.5,
      "weightPerPoint": 25,
      "specialRules": [
        "Heavy metal armor"
      ]
    },
    "lr-metal": {
      "id": "armor-lr-metal",
      "name": "Laser Reflective Metal Armor",
      "costPerPoint": 28.6,
      "weightPerPoint": 25,
      "specialRules": [
        "Laser reflective",
        "Heavy metal armor"
      ]
    }
  }
}

------------------------------------------------------------
JSON: \data\bodies.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "bodies": {
    "cycle": [
      {
        "id": "light-cycle",
        "name": "Light Cycle",
        "category": "cycle",
        "cost": 200,
        "weight": 250,
        "maxWeight": 800,
        "spaces": 4,
        "cargoSpaces": 0,
        "armorCostPerPoint": 10,
        "armorWeightPerPoint": 4,
        "specialRules": [
          "Uses cycle tires only",
          "Uses cycle power plants only",
          "Cannot mount turrets",
          "May mount only cycle-class weapons"
        ]
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      {
        "id": "ca-sloped-streamlined",
        "name": "CA Sloped Streamlined",
        "category": "body-mod",
        "costMultiplier": 1.1,
        "weightMultiplier": 1.0,
        "armorCostMultiplier": 1.0,
        "armorWeightMultiplier": 1.0,
        "specialRules": [
          "Takes double damage in rams",
          "-1 to be hit",
          "Raises top speed and MPG by 10%"
        ]
      }
    ]
  }
}


    

------------------------------------------------------------
JSON: \data\chassis.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "chassis": {
    "cycle": [
      {
        "id": "cycle",
        "name": "Cycle Chassis",
        "costMultiplier": 1.0,
        "maxWeightMultiplier": 1.0,
        "allowedBodyCategories": ["cycle"],
        "minWheels": 2,
        "maxWheels": 2,
        "specialRules": [
          "Chassis cost and weight included in body",
          "Only valid for cycle bodies"
        ]
      }
    ],

    "light": [
      {
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
      {
        "id": "extra-heavy",
        "name": "Extra-Heavy Chassis",
        "costMultiplier": 1.0,
        "flatCostAdjustment": 300,
        "maxWeightMultiplier": 1.2,
        "allowedBodyCategories": ["car", "pickup", "camper", "van"],
        "minWheels": 6,
        "maxWheels": 6,
        "requiresSixWheelsOverWeight": 5500,
        "specialRules": [
          "Required for vehicles over 5500 lbs",
          "Required for 6-wheel vehicles",
          "Required for pickups and larger bodies over 5500 lbs",
          "Strongest available chassis"
        ]
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\engine-mods.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "engineMods": {
    "single": [
      {
        "id": "carburetor",
        "name": "Carburetor",
        "type": "gas-mod",
        "addedWeight": 0,
        "addedSpaces": 0,
        "addedDP": 0,
        "addedCost": 0,
        "pfBonus": 0,
        "mpgBonus": 0,
        "accelBonus": 0,
        "specialRules": []
      },
      {
        "id": "multi-barrel",
        "name": "Multi-Barrel Carburetor",
        "type": "gas-mod",
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        "mpgBonus": 0,
        "accelBonus": 0,
        "specialRules": []
      },
      {
        "id": "tubes-blue-turbo-supercharger",
        "name": "Tube Headers + Blue Printing + Turbo + Supercharger",
        "type": "gas-mod",
        "addedWeight": 10,
        "addedSpaces": 0,
        "addedDP": 0,
        "addedCost": 0,
        "pfBonus": 0,
        "mpgBonus": 0,
        "accelBonus": 0,
        "specialRules": []
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\gas-tanks.json
------------------------------------------------------------
{
  "gasTanks": {
    "perGallon": {
      "weightPerGallon": 1,
      "costPerGallon": 2,
      "dpPerTank": 2
    },

    "spaceRules": [
      {
        "id": "tank-size-0-5",
        "minGallons": 0,
        "maxGallons": 5,
        "spacesPerGallon": 0
      },
      {
        "id": "tank-size-6-15",
        "minGallons": 6,
        "maxGallons": 15,
        "spacesPerGallon": 1
      },
      {
        "id": "tank-size-16-25",
        "minGallons": 16,
        "maxGallons": 25,
        "spacesPerGallon": 2
      },
      {
        "id": "tank-size-26-plus",
        "minGallons": 26,
        "maxGallons": null,
        "spacesPerGallon": 3
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\powerplants.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "powerplants": {
    "gas": [
      {
        "id": "gas-10cid",
        "name": "10 cid Gas Engine",
        "type": "gas",
        "weight": 60,
        "spaces": 1,
        "dp": 1,
        "cost": 400,
        "pf": 300,
        "baseMPG": 80,
        "specialRules": []
      },
      {
        "id": "gas-30cid",
        "name": "30 cid Gas Engine",
        "type": "gas",
        "weight": 115,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        "cost": 6000,
        "pf": 3000,
        "baseMPG": 0,
        "specialRules": []
      },
      {
        "id": "elec-thundercat",
        "name": "ThunderCat Electric",
        "type": "electric",
        "weight": 2000,
        "spaces": 8,
        "dp": 15,
        "cost": 12000,
        "pf": 6700,
        "baseMPG": 0,
        "specialRules": []
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\suspension.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "suspension": {
    "cycle": [
      {
        "id": "cycle-light",
        "name": "Cycle Light",
        "category": "cycle",
        "cost": 0,
        "handlingBonus": 0,
        "vanHandlingBonus": 0,
        "subcompactHandlingBonus": 0,
        "specialRules": []
      },
      {
        "id": "cycle-improved",
        "name": "Cycle Improved",
        "category": "cycle",
        "cost": 300,
        "handlingBonus": 1,
        "vanHandlingBonus": 0,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        "subcompactHandlingBonus": 2,
        "specialRules": []
      }
    ],
    "racing": [
      {
        "id": "racing",
        "name": "Racing Suspension",
        "category": "racing",
        "cost": 0,
        "handlingBonus": 5,
        "vanHandlingBonus": 0,
        "subcompactHandlingBonus": 0,
        "specialRules": [
          "Only valid for racing bodies"
        ]
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\tire-options.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "tireOptions": {
    "base": [
      {
        "id": "normal",
        "name": "Normal Tire Option",
        "category": "option",
        "cost": 50,
        "weight": 30,
        "dp": 4,
        "handlingBonus": 0,
        "specialRules": []
      },
      {
        "id": "steelbelting",
        "name": "Steelbelting",
        "category": "option",
        "cost": 75,
        "weight": 45,
        "dp": 5,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        "weight": 54,
        "dp": 5,
        "handlingBonus": 1,
        "specialRules": [
          "HC +1"
        ]
      },
      {
        "id": "steel-offroad-fireproof",
        "name": "Steel/Off-Road / FP",
        "category": "combo",
        "cost": 180,
        "weight": 50,
        "dp": 5,
        "handlingBonus": 0,
        "specialRules": []
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\tires.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "tires": {
    "standard": [
      {
        "id": "standard",
        "name": "Standard Tire",
        "category": "base",
        "cost": 50,
        "weight": 30,
        "dp": 4,
        "specialRules": []
      }
    ],
    "heavy-duty": [
      {
        "id": "heavy-duty",
        "name": "Heavy-Duty Tire",
        "category": "base",
        "cost": 100,
        "weight": 40,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        "weight": 75,
        "dp": 12,
        "specialRules": []
      }
    ],
    "plasticore": [
      {
        "id": "plasticore",
        "name": "Plasticore Tire",
        "category": "base",
        "cost": 1000,
        "weight": 150,
        "dp": 25,
        "specialRules": [
          "Cannot use Radial, Off-Road, or Steel options"
        ]
      }
    ]
  }
}

------------------------------------------------------------
JSON: \data\weapons.json
------------------------------------------------------------
---- BEGIN FIRST 20 LINES ----
{
  "weapons": {
    "smallBore": [
      {
        "id": "lmg-regular",
        "name": "Light Machine Gun (Regular)",
        "category": "smallBore",
        "ammoType": "Regular",
        "abbreviation": "LMG",
        "effect": "Area",
        "toHit": 7,
        "damage": "1D-1",
        "dp": 2,
        "cost": 850,
        "weight": 100,
        "spaces": 1,
        "shots": 20,
        "shotCost": 20,
        "shotWeight": 2.5,
        "magazineCost": 1250,
---- ... SNIPPED ... ----
---- END LAST 20 LINES ----
        "abbreviation": "AD",
        "effect": "Spray (Front/Back)",
        "toHit": 0,
        "damage": "1D-1 (corrosive)",
        "dp": 1,
        "cost": 200,
        "weight": 10,
        "spaces": 0,
        "shots": 3,
        "shotCost": 0,
        "shotWeight": 0,
        "magazineCost": 200,
        "magazineWeight": 10,
        "specialRules": [
          "Corrosive"
        ]
      }
    ]
  }
}

------------------------------------------------------------
JSON: \system.json
------------------------------------------------------------
{
  "id": "carwars-system",
  "title": "Car Wars (Custom System)",
  "description": "A Foundry VTT v13 system shell for Car Wars.",
  "version": "0.1.1",
  "compatibility": {
    "minimum": "13",
    "verified": "13"
  },
  "authors": [
    { "name": "Kevin" }
  ],
  "esmodules": [
    "module/carwars.js",
    "module/actor/actor-sheet.js",
    "module/actor/register-sheets.js"
  ],
  "styles": ["styles/carwars.css"],
  "templates": [
    "templates",
    "templates/actor",
    "templates/actor/partials"
  ],
  "packs": [],
  "flags": {
    "carwars-system": {
      "dataPath": "systems/carwars-system/data"
    }
  }
}

------------------------------------------------------------
JSON: \template.json
------------------------------------------------------------
{
  "Actor": {
    "types": ["vehicle", "driver"],
    "templates": {
      "vehicle": {},
      "driver": {}
    }
  },
  "Item": {
    "types": ["weapon", "armor", "powerplant", "tire", "accessory", "suspension"],
    "templates": {}
  }
}
